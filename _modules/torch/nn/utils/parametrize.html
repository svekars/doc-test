
<!DOCTYPE html>


<html lang="en" data-content_root="../../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>torch.nn.utils.parametrize &#8212; PyTorch main documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=949a1ff5" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/katex-math.css?v=91adb8b6" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/jit.css?v=8de1ea5d" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/custom.css?v=3ccf5357" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/custom2.css?v=baa440dc" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../../_static/documentation_options.js?v=a8da1a53"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../../_static/copybutton.js?v=940804e7"></script>
    <script src="../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/torch/nn/utils/parametrize';</script>
    <script src="../../../../_static/js/star-rating.js?v=8861fcb6"></script>
    <script src="../../../../_static/js/send-feedback.js?v=5646bf45"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="main (2.6.0 )" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script type="text/javascript" src="../../../../_static/js/send-feedback.js"></script>
<script type="text/javascript" src="../../../../_static/js/star-rating.js"></script>
<script type="text/javascript" src="../../../../_static/js/cookie-banner.js"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-TEST12345"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-TEST12345');
    </script>

  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
<body data-feedback-url="https://github.com/pytorch/pytorch">
  <div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>

          <li class="main-menu-item">
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Learn
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class=dropdown-title>Get Started</span>
                  <p>Run PyTorch locally or get started quickly with one of the supported cloud platforms</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Tutorials</span>
                  <p>Whats new in PyTorch tutorials</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Learn the Basics</span>
                  <p>Familiarize yourself with PyTorch concepts and modules</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch Recipes</span>
                  <p>Bite-size, ready-to-deploy PyTorch code examples</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Intro to PyTorch - YouTube Series</span>
                  <p>Master PyTorch basics with our engaging YouTube tutorial series</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Ecosystem
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Tools</span>
                  <p>Learn about the tools and frameworks in the PyTorch Ecosystem</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class=dropdown-title>Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="" target="_blank">
                  <span class=dropdown-title>Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class=dropdown-title>Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Contributor Awards - 2024</span>
                  <p>Award winners announced at this year's PyTorch Conference</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Edge
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">About PyTorch Edge</span>
                  <p>Build innovative and privacy-aware AI experiences for edge devices</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">ExecuTorch</span>
                  <p>End-to-end solution for enabling on-device inference capabilities across mobile and edge devices</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">ExecuTorch Docs</span>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch</span>
                  <p>Explore the documentation for comprehensive guidance on how to use PyTorch</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch Domains</span>
                  <p>Read the PyTorch Domains documentation to learn more about domain-specific libraries</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Blogs & News
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch Blog</span>
                  <p>Catch up on the latest technical news and happenings</p>
                </a>
                 <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Community Blog</span>
                  <p>Stories from the PyTorch ecosystem</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Videos</span>
                  <p>Learn about the latest PyTorch tutorials, new, and more </p>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Newsletter</span>
                  <p>Stay up-to-date with the latest updates</p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                About
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn more about the PyTorch Foundation</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Governing Board</span>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Cloud Credit Program</span>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Technical Advisory Council</span>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Staff</span>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Contact Us</span>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
            <div class="no-dropdown">
              <a href="" data-cta="join">
                Become a Member
              </a>
            </div>
          </li>
          <li>
           <div class="main-menu-item">
             <a href="" class="github-icon">
             </a>
           </div>
          </li>
          <!--- TODO: This block adds the search icon to the nav bar. We will enable it later.
          <li>
            <div class="main-menu-item">
             <a href="" class="search-icon">
             </a>
            </div>
          </li>
          --->
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Home</p>
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../python-api/index.html">
    Python API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../notes/index.html">
    Developer Notes
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://pytorch.org/tutorials/">
    Tutorials
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://x.com/PyTorch" title="X" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-x-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">X</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/pytorch/pytorch" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/torch" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-custom fa-pypi fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../python-api/index.html">
    Python API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../notes/index.html">
    Developer Notes
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://pytorch.org/tutorials/">
    Tutorials
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://x.com/PyTorch" title="X" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-x-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">X</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/pytorch/pytorch" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/torch" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-custom fa-pypi fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../../../torch.html" class="nav-link">torch</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">torch.nn.utils.parametrize</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">
<div class="rating">
    Rate this Page
    <div class="stars">
        
        <span class="star" data-value="1">★</span>
        
        <span class="star" data-value="2">★</span>
        
        <span class="star" data-value="3">★</span>
        
        <span class="star" data-value="4">★</span>
        
        <span class="star" data-value="5">★</span>
        
    </div>
</div>
</div>
      
    </div>
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for torch.nn.utils.parametrize</h1><div class="highlight"><pre>
<span></span><span class="c1"># mypy: allow-untyped-decorators</span>
<span class="c1"># mypy: allow-untyped-defs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">collections</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copyreg</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_swap_module_params_on_conversion</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn.modules.container</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span><span class="p">,</span> <span class="n">ModuleDict</span><span class="p">,</span> <span class="n">ModuleList</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn.parameter</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parameter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils._python_dispatch</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_traceable_wrapper_subclass</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;cached&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ParametrizationList&quot;</span><span class="p">,</span>
    <span class="s2">&quot;register_parametrization&quot;</span><span class="p">,</span>
    <span class="s2">&quot;is_parametrized&quot;</span><span class="p">,</span>
    <span class="s2">&quot;remove_parametrizations&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type_before_parametrizations&quot;</span><span class="p">,</span>
    <span class="s2">&quot;transfer_parametrizations_and_params&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">_cache_enabled</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="cached">
<a class="viewcode-back" href="../../../../python-api/generated/torch.nn.utils.parametrize.cached.html#torch.nn.utils.parametrize.cached">[docs]</a>
<span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cached</span><span class="p">():</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Context manager that enables the caching system within parametrizations registered with :func:`register_parametrization`.</span>

<span class="sd">    The value of the parametrized objects is computed and cached the first time</span>
<span class="sd">    they are required when this context manager is active. The cached values are</span>
<span class="sd">    discarded when leaving the context manager.</span>

<span class="sd">    This is useful when using a parametrized parameter more than once in the forward pass.</span>
<span class="sd">    An example of this is when parametrizing the recurrent kernel of an RNN or when</span>
<span class="sd">    sharing weights.</span>

<span class="sd">    The simplest way to activate the cache is by wrapping the forward pass of the neural network</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        import torch.nn.utils.parametrize as P</span>
<span class="sd">        ...</span>
<span class="sd">        with P.cached():</span>
<span class="sd">            output = model(inputs)</span>

<span class="sd">    in training and evaluation. One may also wrap the parts of the modules that use</span>
<span class="sd">    several times the parametrized tensors. For example, the loop of an RNN with a</span>
<span class="sd">    parametrized recurrent kernel:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        with P.cached():</span>
<span class="sd">            for x in xs:</span>
<span class="sd">                out_rnn = self.rnn_cell(x, out_rnn)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_cache</span>
    <span class="k">global</span> <span class="n">_cache_enabled</span>
    <span class="n">_cache_enabled</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">_cache_enabled</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_cache_enabled</span><span class="p">:</span>
            <span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_register_parameter_or_buffer</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">):</span>
        <span class="n">module</span><span class="o">.</span><span class="n">register_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">module</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_maybe_set</span><span class="p">(</span><span class="n">dest</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">src</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">should_swap</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">get_swap_module_params_on_conversion</span><span class="p">()</span> <span class="ow">or</span> <span class="n">is_traceable_wrapper_subclass</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">should_swap</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">):</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="n">dest</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">swap_tensors</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dest</span><span class="o">.</span><span class="n">set_</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>  <span class="c1"># type: ignore[call-overload]</span>


<div class="viewcode-block" id="ParametrizationList">
<a class="viewcode-back" href="../../../../python-api/generated/torch.nn.utils.parametrize.ParametrizationList.html#torch.nn.utils.parametrize.ParametrizationList">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ParametrizationList</span><span class="p">(</span><span class="n">ModuleList</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;A sequential container that holds and manages the original parameters or buffers of a parametrized :class:`torch.nn.Module`.</span>

<span class="sd">    It is the type of ``module.parametrizations[tensor_name]`` when ``module[tensor_name]``</span>
<span class="sd">    has been parametrized with :func:`register_parametrization`.</span>

<span class="sd">    If the first registered parametrization has a ``right_inverse`` that returns one tensor or</span>
<span class="sd">    does not have a ``right_inverse`` (in which case we assume that ``right_inverse`` is the identity),</span>
<span class="sd">    it will hold the tensor under the name ``original``.</span>
<span class="sd">    If it has a ``right_inverse`` that returns more than one tensor, these will be registered as</span>
<span class="sd">    ``original0``, ``original1``, ...</span>

<span class="sd">    .. warning::</span>
<span class="sd">        This class is used internally by :func:`register_parametrization`. It is documented</span>
<span class="sd">        here for completeness. It shall not be instantiated by the user.</span>

<span class="sd">    Args:</span>
<span class="sd">        modules (sequence): sequence of modules representing the parametrizations</span>
<span class="sd">        original (Parameter or Tensor): parameter or buffer that is parametrized</span>
<span class="sd">        unsafe (bool): a boolean flag that denotes whether the parametrization</span>
<span class="sd">            may change the dtype and shape of the tensor. Default: `False`</span>
<span class="sd">            Warning: the parametrization is not checked for consistency upon registration.</span>
<span class="sd">            Enable this flag at your own risk.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">original</span><span class="p">:</span> <span class="n">Tensor</span>
    <span class="n">unsafe</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">modules</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Module</span><span class="p">],</span>
        <span class="n">original</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">],</span>
        <span class="n">unsafe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># We require this because we need to treat differently the first parametrization</span>
        <span class="c1"># This should never throw, unless this class is used from the outside</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ParametrizationList requires one or more modules.&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unsafe</span> <span class="o">=</span> <span class="n">unsafe</span>

        <span class="c1"># In plain words:</span>
        <span class="c1"># module.weight must keep its dtype and shape.</span>
        <span class="c1"># Furthermore, if there is no right_inverse or the right_inverse returns a tensor,</span>
        <span class="c1"># this should be of the same dtype as the original tensor</span>
        <span class="c1">#</span>
        <span class="c1"># We check that the following invariants hold:</span>
        <span class="c1">#    X = module.weight</span>
        <span class="c1">#    Y = param.right_inverse(X)</span>
        <span class="c1">#    assert isinstance(Y, Tensor) or</span>
        <span class="c1">#           (isinstance(Y, collections.abc.Sequence) and all(isinstance(t, Tensor) for t in Y))</span>
        <span class="c1">#    Z = param(Y) if isinstance(Y, Tensor) else param(*Y)</span>
        <span class="c1">#    # Consistency checks</span>
        <span class="c1">#    assert X.dtype == Z.dtype and X.shape == Z.shape</span>
        <span class="c1">#    # If it has one input, this allows to be able to use set_ to be able to</span>
        <span class="c1">#    # move data to/from the original tensor without changing its id (which is what the</span>
        <span class="c1">#    # optimizer uses to track parameters)</span>
        <span class="c1">#    if isinstance(Y, Tensor)</span>
        <span class="c1">#      assert X.dtype == Y.dtype</span>
        <span class="c1"># Below we use original = X, new = Y</span>

        <span class="n">original_shape</span> <span class="o">=</span> <span class="n">original</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">original_dtype</span> <span class="o">=</span> <span class="n">original</span><span class="o">.</span><span class="n">dtype</span>

        <span class="c1"># Compute new</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">original</span>
            <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># type: ignore[call-overload]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;right_inverse&quot;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">right_inverse</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>  <span class="c1"># type: ignore[operator]</span>
                    <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="c1"># else, or if it throws, we assume that right_inverse is the identity</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">new</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;&#39;right_inverse&#39; must return a Tensor or a Sequence of tensors (list, tuple...). &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">new</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Set the number of original tensors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_tensor</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntensors</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_tensor</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>

        <span class="c1"># Register the tensor(s)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">original</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">new</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;When `right_inverse` outputs one tensor, it may not change the dtype.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;original.dtype: </span><span class="si">{</span><span class="n">original</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;right_inverse(original).dtype: </span><span class="si">{</span><span class="n">new</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Set the original to original so that the user does not need to re-register the parameter</span>
            <span class="c1"># manually in the optimiser</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">_maybe_set</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
            <span class="n">_register_parameter_or_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;original&quot;</span><span class="p">,</span> <span class="n">original</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">originali</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">originali</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;&#39;right_inverse&#39; must return a Tensor or a Sequence of tensors &quot;</span>
                        <span class="s2">&quot;(list, tuple...). &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Got element </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> of the sequence with type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">originali</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># If the original tensor was a Parameter that required grad, we expect the user to</span>
                <span class="c1"># add the new parameters to the optimizer after registering the parametrization</span>
                <span class="c1"># (this is documented)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">):</span>
                    <span class="n">originali</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">originali</span><span class="p">,</span> <span class="n">original</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>
                <span class="n">originali</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>
                <span class="n">_register_parameter_or_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;original</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">originali</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsafe</span><span class="p">:</span>
            <span class="c1"># Consistency checks:</span>
            <span class="c1"># Since f : A -&gt; B, right_inverse : B -&gt; A, Z and original should live in B</span>
            <span class="c1"># Z = forward(right_inverse(original))</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;A parametrization must return a tensor. Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">Z</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">original_dtype</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Registering a parametrization may not change the dtype of the tensor, unless `unsafe` flag is enabled.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;unparametrized dtype: </span><span class="si">{</span><span class="n">original_dtype</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;parametrized dtype: </span><span class="si">{</span><span class="n">Z</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">Z</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">original_shape</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Registering a parametrization may not change the shape of the tensor, unless `unsafe` flag is enabled.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;unparametrized shape: </span><span class="si">{</span><span class="n">original_shape</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;parametrized shape: </span><span class="si">{</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

<div class="viewcode-block" id="ParametrizationList.right_inverse">
<a class="viewcode-back" href="../../../../python-api/generated/torch.nn.utils.parametrize.ParametrizationList.html#torch.nn.utils.parametrize.ParametrizationList.right_inverse">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">right_inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Call the ``right_inverse`` methods of the parametrizations in the inverse registration order.</span>

<span class="sd">        Then, it stores the result in ``self.original`` if ``right_inverse`` outputs one tensor</span>
<span class="sd">        or in ``self.original0``, ``self.original1``, ... if it outputs several.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (Tensor): Value to which initialize the module</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># All the exceptions in this function should almost never throw.</span>
        <span class="c1"># They could throw if, for example, right_inverse function returns a different</span>
        <span class="c1"># dtype when given a different input, which should most likely be caused by a</span>
        <span class="c1"># bug in the user&#39;s code</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="c1"># See https://github.com/pytorch/pytorch/issues/53103</span>
            <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># type: ignore[call-overload]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;right_inverse&quot;</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">right_inverse</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># type: ignore[operator]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;parametrization </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">module</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> does not implement &quot;</span>
                        <span class="s2">&quot;right_inverse.&quot;</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">:</span>
                <span class="c1"># These exceptions should only throw when a right_inverse function does not</span>
                <span class="c1"># return the same dtype for every input, which should most likely be caused by a bug</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;`right_inverse` should return a tensor. Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The tensor returned by `right_inverse` has dtype </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;while `original` has dtype </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">original</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="c1"># We know that the result is going to have the same dtype</span>
                <span class="n">_maybe_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;&#39;right_inverse&#39; must return a sequence of tensors. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntensors</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;&#39;right_inverse&#39; must return a sequence of tensors of length &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ntensors</span><span class="si">}</span><span class="s2">. Got a sequence of length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="n">original_i</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;original</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;`right_inverse` must return a sequence of tensors. &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Got element </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">original_i</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Tensor </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> returned by `right_inverse` has dtype </span><span class="si">{</span><span class="n">tensor</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;while `original</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">` has dtype </span><span class="si">{</span><span class="n">original_i</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="n">_maybe_set</span><span class="p">(</span><span class="n">original_i</span><span class="p">,</span> <span class="n">tensor</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">is_scripting</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Parametrization is not working with scripting.&quot;</span><span class="p">)</span>
        <span class="c1"># Unpack the originals for the first parametrization</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">original</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">originals</span> <span class="o">=</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;original</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntensors</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="o">*</span><span class="n">originals</span><span class="p">)</span>
        <span class="c1"># It&#39;s not possible to call self[1:] here, so we have to be a bit more cryptic</span>
        <span class="c1"># Also we want to skip all non-integer keys</span>
        <span class="n">curr_idx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">curr_idx</span><span class="p">)):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">curr_idx</span><span class="p">](</span><span class="n">x</span><span class="p">)</span>
            <span class="n">curr_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">x</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_inject_new_class</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Set up a module to be parametrized.</span>

<span class="sd">    This works by substituting the class of the module by a class</span>
<span class="sd">    that extends it to be able to inject a property</span>

<span class="sd">    Args:</span>
<span class="sd">        module (nn.Module): module into which to inject the property</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__class__</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">default_deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="c1"># Just emulate a standard deepcopy procedure when __deepcopy__ doesn&#39;t exist in the current class.</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">memo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="n">replica</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">memo</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span> <span class="o">=</span> <span class="n">replica</span>
        <span class="n">replica</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
        <span class="c1"># Also save all slots if they exist.</span>
        <span class="n">slots_to_save</span> <span class="o">=</span> <span class="n">copyreg</span><span class="o">.</span><span class="n">_slotnames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">slots_to_save</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">replica</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">),</span> <span class="n">memo</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">replica</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">getstate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Serialization of parametrized modules is only &quot;</span>
            <span class="s2">&quot;supported through state_dict(). See:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;https://pytorch.org/tutorials/beginner/saving_loading_models.html&quot;</span>
            <span class="s2">&quot;#saving-loading-a-general-checkpoint-for-inference-and-or-resuming-training&quot;</span>
        <span class="p">)</span>

    <span class="n">dct</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;__getstate__&quot;</span><span class="p">:</span> <span class="n">getstate</span><span class="p">}</span>
    <span class="c1"># We don&#39;t allow serialization of parametrized modules but should still allow deepcopying.</span>
    <span class="c1"># Default &#39;deepcopy&#39; function invokes __deepcopy__ method instead of __getstate__ when it exists.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__deepcopy__&quot;</span><span class="p">):</span>
        <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;__deepcopy__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_deepcopy</span>  <span class="c1"># type: ignore[assignment]</span>

    <span class="n">param_cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Parametrized</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="bp">cls</span><span class="p">,),</span>
        <span class="n">dct</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">module</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">param_cls</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_inject_property</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> <span class="n">tensor_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Injects a property into module[tensor_name].</span>

<span class="sd">    It assumes that the class in the module has already been modified from its</span>
<span class="sd">    original one using _inject_new_class and that the tensor under :attr:`tensor_name`</span>
<span class="sd">    has already been moved out</span>

<span class="sd">    Args:</span>
<span class="sd">        module (nn.Module): module into which to inject the property</span>
<span class="sd">        tensor_name (str): name of the name of the property to create</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># We check the precondition.</span>
    <span class="c1"># This should never fire if register_parametrization is correctly implemented</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">tensor_name</span><span class="p">)</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">unused</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_cached_parametrization</span><span class="p">(</span><span class="n">parametrization</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">_cache</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">module</span><span class="p">),</span> <span class="n">tensor_name</span><span class="p">)</span>
        <span class="n">tensor</span> <span class="o">=</span> <span class="n">_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tensor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tensor</span> <span class="o">=</span> <span class="n">parametrization</span><span class="p">()</span>
            <span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor</span>
        <span class="k">return</span> <span class="n">tensor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_parametrized</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">is_scripting</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Parametrization is not working with scripting.&quot;</span><span class="p">)</span>
        <span class="n">parametrization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">[</span><span class="n">tensor_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">_cache_enabled</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">is_scripting</span><span class="p">():</span>
                <span class="c1"># Scripting</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Caching is not implemented for scripting. &quot;</span>
                    <span class="s2">&quot;Either disable caching or avoid scripting.&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_get_tracing_state</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Tracing</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot trace a model while caching parametrizations.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">get_cached_parametrization</span><span class="p">(</span><span class="n">parametrization</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If caching is not active, this function just evaluates the parametrization</span>
            <span class="k">return</span> <span class="n">parametrization</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_original</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">is_scripting</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Parametrization is not working with scripting.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">[</span><span class="n">tensor_name</span><span class="p">]</span><span class="o">.</span><span class="n">right_inverse</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nb">setattr</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">tensor_name</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_parametrized</span><span class="p">,</span> <span class="n">set_original</span><span class="p">))</span>


<div class="viewcode-block" id="register_parametrization">
<a class="viewcode-back" href="../../../../python-api/generated/torch.nn.utils.parametrize.register_parametrization.html#torch.nn.utils.parametrize.register_parametrization">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">register_parametrization</span><span class="p">(</span>
    <span class="n">module</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span>
    <span class="n">tensor_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">parametrization</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">unsafe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Module</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Register a parametrization to a tensor in a module.</span>

<span class="sd">    Assume that ``tensor_name=&quot;weight&quot;`` for simplicity. When accessing ``module.weight``,</span>
<span class="sd">    the module will return the parametrized version ``parametrization(module.weight)``.</span>
<span class="sd">    If the original tensor requires a gradient, the backward pass will differentiate</span>
<span class="sd">    through :attr:`parametrization`, and the optimizer will update the tensor accordingly.</span>

<span class="sd">    The first time that a module registers a parametrization, this function will add an attribute</span>
<span class="sd">    ``parametrizations`` to the module of type :class:`~ParametrizationList`.</span>

<span class="sd">    The list of parametrizations on the tensor ``weight`` will be accessible under</span>
<span class="sd">    ``module.parametrizations.weight``.</span>

<span class="sd">    The original tensor will be accessible under</span>
<span class="sd">    ``module.parametrizations.weight.original``.</span>

<span class="sd">    Parametrizations may be concatenated by registering several parametrizations</span>
<span class="sd">    on the same attribute.</span>

<span class="sd">    The training mode of a registered parametrization is updated on registration</span>
<span class="sd">    to match the training mode of the host module</span>

<span class="sd">    Parametrized parameters and buffers have an inbuilt caching system that can be activated</span>
<span class="sd">    using the context manager :func:`cached`.</span>

<span class="sd">    A :attr:`parametrization` may optionally implement a method with signature</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        def right_inverse(self, X: Tensor) -&gt; Union[Tensor, Sequence[Tensor]]</span>

<span class="sd">    This method is called on the unparametrized tensor when the first parametrization</span>
<span class="sd">    is registered to compute the initial value of the original tensor.</span>
<span class="sd">    If this method is not implemented, the original tensor will be just the unparametrized tensor.</span>

<span class="sd">    If all the parametrizations registered on a tensor implement `right_inverse` it is possible</span>
<span class="sd">    to initialize a parametrized tensor by assigning to it, as shown in the example below.</span>

<span class="sd">    It is possible for the first parametrization to depend on several inputs.</span>
<span class="sd">    This may be implemented returning a tuple of tensors from ``right_inverse``</span>
<span class="sd">    (see the example implementation of a ``RankOne`` parametrization below).</span>

<span class="sd">    In this case, the unconstrained tensors are also located under ``module.parametrizations.weight``</span>
<span class="sd">    with names ``original0``, ``original1``,...</span>

<span class="sd">    .. note::</span>

<span class="sd">        If unsafe=False (default) both the forward and right_inverse methods will be called</span>
<span class="sd">        once to perform a number of consistency checks.</span>
<span class="sd">        If unsafe=True, then right_inverse will be called if the tensor is not parametrized,</span>
<span class="sd">        and nothing will be called otherwise.</span>

<span class="sd">    .. note::</span>

<span class="sd">        In most situations, ``right_inverse`` will be a function such that</span>
<span class="sd">        ``forward(right_inverse(X)) == X`` (see</span>
<span class="sd">        `right inverse &lt;https://en.wikipedia.org/wiki/Inverse_function#Right_inverses&gt;`_).</span>
<span class="sd">        Sometimes, when the parametrization is not surjective, it may be reasonable</span>
<span class="sd">        to relax this.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        If a parametrization depends on several inputs, :func:`~register_parametrization`</span>
<span class="sd">        will register a number of new parameters. If such parametrization is registered</span>
<span class="sd">        after the optimizer is created, these new parameters will need to be added manually</span>
<span class="sd">        to the optimizer. See :meth:`torch.Optimizer.add_param_group`.</span>

<span class="sd">    Args:</span>
<span class="sd">        module (nn.Module): module on which to register the parametrization</span>
<span class="sd">        tensor_name (str): name of the parameter or buffer on which to register</span>
<span class="sd">            the parametrization</span>
<span class="sd">        parametrization (nn.Module): the parametrization to register</span>
<span class="sd">    Keyword args:</span>
<span class="sd">        unsafe (bool): a boolean flag that denotes whether the parametrization</span>
<span class="sd">            may change the dtype and shape of the tensor. Default: `False`</span>
<span class="sd">            Warning: the parametrization is not checked for consistency upon registration.</span>
<span class="sd">            Enable this flag at your own risk.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: if the module does not have a parameter or a buffer named :attr:`tensor_name`</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(env:TORCH_DOCTEST_LAPACK)</span>
<span class="sd">        &gt;&gt;&gt; import torch</span>
<span class="sd">        &gt;&gt;&gt; import torch.nn as nn</span>
<span class="sd">        &gt;&gt;&gt; import torch.nn.utils.parametrize as P</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; class Symmetric(nn.Module):</span>
<span class="sd">        &gt;&gt;&gt;     def forward(self, X):</span>
<span class="sd">        &gt;&gt;&gt;         return X.triu() + X.triu(1).T  # Return a symmetric matrix</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt;     def right_inverse(self, A):</span>
<span class="sd">        &gt;&gt;&gt;         return A.triu()</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; m = nn.Linear(5, 5)</span>
<span class="sd">        &gt;&gt;&gt; P.register_parametrization(m, &quot;weight&quot;, Symmetric())</span>
<span class="sd">        &gt;&gt;&gt; print(torch.allclose(m.weight, m.weight.T))  # m.weight is now symmetric</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; A = torch.rand(5, 5)</span>
<span class="sd">        &gt;&gt;&gt; A = A + A.T   # A is now symmetric</span>
<span class="sd">        &gt;&gt;&gt; m.weight = A  # Initialize the weight to be the symmetric matrix A</span>
<span class="sd">        &gt;&gt;&gt; print(torch.allclose(m.weight, A))</span>
<span class="sd">        True</span>

<span class="sd">        &gt;&gt;&gt; class RankOne(nn.Module):</span>
<span class="sd">        &gt;&gt;&gt;     def forward(self, x, y):</span>
<span class="sd">        &gt;&gt;&gt;         # Form a rank 1 matrix multiplying two vectors</span>
<span class="sd">        &gt;&gt;&gt;         return x.unsqueeze(-1) @ y.unsqueeze(-2)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt;     def right_inverse(self, Z):</span>
<span class="sd">        &gt;&gt;&gt;         # Project Z onto the rank 1 matrices</span>
<span class="sd">        &gt;&gt;&gt;         U, S, Vh = torch.linalg.svd(Z, full_matrices=False)</span>
<span class="sd">        &gt;&gt;&gt;         # Return rescaled singular vectors</span>
<span class="sd">        &gt;&gt;&gt;         s0_sqrt = S[0].sqrt().unsqueeze(-1)</span>
<span class="sd">        &gt;&gt;&gt;         return U[..., :, 0] * s0_sqrt, Vh[..., 0, :] * s0_sqrt</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; linear_rank_one = P.register_parametrization(nn.Linear(4, 4), &quot;weight&quot;, RankOne())</span>
<span class="sd">        &gt;&gt;&gt; print(torch.linalg.matrix_rank(linear_rank_one.weight).item())</span>
<span class="sd">        1</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parametrization</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">training</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_parametrized</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">tensor_name</span><span class="p">):</span>
        <span class="c1"># Correctness checks.</span>
        <span class="c1"># If A is the space of tensors with shape and dtype equal to module.weight</span>
        <span class="c1"># we check that parametrization.forward and parametrization.right_inverse are</span>
        <span class="c1"># functions from A to A</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">unsafe</span><span class="p">:</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">tensor_name</span><span class="p">)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">parametrization</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;A parametrization must return a tensor. Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">Y</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Registering a parametrization may not change the dtype of the tensor, unless the `unsafe` flag is enabled.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;module.</span><span class="si">{</span><span class="n">tensor_name</span><span class="si">}</span><span class="s2">.dtype: </span><span class="si">{</span><span class="n">Y</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;parametrization(module.</span><span class="si">{</span><span class="n">tensor_name</span><span class="si">}</span><span class="s2">).dtype: </span><span class="si">{</span><span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Registering a parametrization may not change the shape of the tensor, unless the `unsafe` flag is enabled.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;module.</span><span class="si">{</span><span class="n">tensor_name</span><span class="si">}</span><span class="s2">.shape: </span><span class="si">{</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;parametrization(module.</span><span class="si">{</span><span class="n">tensor_name</span><span class="si">}</span><span class="s2">).shape: </span><span class="si">{</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parametrization</span><span class="p">,</span> <span class="s2">&quot;right_inverse&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">parametrization</span><span class="o">.</span><span class="n">right_inverse</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>  <span class="c1"># type: ignore[operator]</span>
                <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;parametrization.right_inverse must return a tensor. Got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">Z</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">Y</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;The tensor returned by parametrization.right_inverse must have the same dtype &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;as module.</span><span class="si">{</span><span class="n">tensor_name</span><span class="si">}</span><span class="s2">, unless the `unsafe` flag is enabled.</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;module.</span><span class="si">{</span><span class="n">tensor_name</span><span class="si">}</span><span class="s2">.dtype: </span><span class="si">{</span><span class="n">Y</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;returned dtype: </span><span class="si">{</span><span class="n">Z</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">Z</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;The tensor returned by parametrization.right_inverse must have the same shape &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;as module.</span><span class="si">{</span><span class="n">tensor_name</span><span class="si">}</span><span class="s2">, unless the `unsafe` flag is enabled.</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;module.</span><span class="si">{</span><span class="n">tensor_name</span><span class="si">}</span><span class="s2">.shape: </span><span class="si">{</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;returned shape: </span><span class="si">{</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
            <span class="c1"># else right_inverse is assumed to be the identity</span>

        <span class="c1"># add the new parametrization to the parametrization list</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">,</span> <span class="n">ModuleDict</span><span class="p">)</span>  <span class="c1"># Make mypy happy</span>
        <span class="n">module</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">[</span><span class="n">tensor_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parametrization</span><span class="p">)</span>
        <span class="c1"># If unsafe was True in previous parametrization, keep it enabled</span>
        <span class="n">module</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">[</span><span class="n">tensor_name</span><span class="p">]</span><span class="o">.</span><span class="n">unsafe</span> <span class="o">|=</span> <span class="n">unsafe</span>  <span class="c1"># type: ignore[index, union-attr]</span>
    <span class="k">elif</span> <span class="n">tensor_name</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">_buffers</span> <span class="ow">or</span> <span class="n">tensor_name</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">_parameters</span><span class="p">:</span>
        <span class="c1"># Set the parametrization mechanism</span>
        <span class="c1"># Fetch the original buffer or parameter</span>
        <span class="n">original</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">tensor_name</span><span class="p">)</span>
        <span class="c1"># We create this early to check for possible errors</span>
        <span class="n">parametrizations</span> <span class="o">=</span> <span class="n">ParametrizationList</span><span class="p">(</span>
            <span class="p">[</span><span class="n">parametrization</span><span class="p">],</span> <span class="n">original</span><span class="p">,</span> <span class="n">unsafe</span><span class="o">=</span><span class="n">unsafe</span>
        <span class="p">)</span>
        <span class="c1"># Delete the previous parameter or buffer</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">tensor_name</span><span class="p">)</span>
        <span class="c1"># If this is the first parametrization registered on the module,</span>
        <span class="c1"># we prepare the module to inject the property</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_parametrized</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
            <span class="c1"># Change the class</span>
            <span class="n">_inject_new_class</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
            <span class="c1"># Inject a ``ModuleDict`` into the instance under module.parametrizations</span>
            <span class="n">module</span><span class="o">.</span><span class="n">parametrizations</span> <span class="o">=</span> <span class="n">ModuleDict</span><span class="p">()</span>
        <span class="c1"># Add a property into the class</span>
        <span class="n">_inject_property</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">tensor_name</span><span class="p">)</span>
        <span class="c1"># Add a ParametrizationList</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">,</span> <span class="n">ModuleDict</span><span class="p">)</span>  <span class="c1"># Make mypy happy</span>
        <span class="n">module</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">[</span><span class="n">tensor_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">parametrizations</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Module &#39;</span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2">&#39; does not have a parameter, a buffer, or a &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;parametrized element with name &#39;</span><span class="si">{</span><span class="n">tensor_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">module</span></div>



<div class="viewcode-block" id="is_parametrized">
<a class="viewcode-back" href="../../../../python-api/generated/torch.nn.utils.parametrize.is_parametrized.html#torch.nn.utils.parametrize.is_parametrized">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_parametrized</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> <span class="n">tensor_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Determine if a module has a parametrization.</span>

<span class="sd">    Args:</span>
<span class="sd">        module (nn.Module): module to query</span>
<span class="sd">        tensor_name (str, optional): name of the parameter in the module</span>
<span class="sd">            Default: ``None``</span>
<span class="sd">    Returns:</span>
<span class="sd">        ``True`` if :attr:`module` has a parametrization for the parameter named :attr:`tensor_name`,</span>
<span class="sd">        or if it has any parametrization when :attr:`tensor_name` is ``None``;</span>
<span class="sd">        otherwise ``False``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parametrizations</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;parametrizations&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parametrizations</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parametrizations</span><span class="p">,</span> <span class="n">ModuleDict</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">tensor_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Check that there is at least one parametrized buffer or Parameter</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">parametrizations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tensor_name</span> <span class="ow">in</span> <span class="n">parametrizations</span></div>



<div class="viewcode-block" id="remove_parametrizations">
<a class="viewcode-back" href="../../../../python-api/generated/torch.nn.utils.parametrize.remove_parametrizations.html#torch.nn.utils.parametrize.remove_parametrizations">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_parametrizations</span><span class="p">(</span>
    <span class="n">module</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span>
    <span class="n">tensor_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">leave_parametrized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Module</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Remove the parametrizations on a tensor in a module.</span>

<span class="sd">    - If ``leave_parametrized=True``, ``module[tensor_name]`` will be set to</span>
<span class="sd">      its current output. In this case, the parametrization shall not change the ``dtype``</span>
<span class="sd">      of the tensor.</span>
<span class="sd">    - If ``leave_parametrized=False``, ``module[tensor_name]`` will be set to</span>
<span class="sd">      the unparametrised tensor in ``module.parametrizations[tensor_name].original``.</span>
<span class="sd">      This is only possible when the parametrization depends on just one tensor.</span>

<span class="sd">    Args:</span>
<span class="sd">        module (nn.Module): module from which remove the parametrization</span>
<span class="sd">        tensor_name (str): name of the parametrization to be removed</span>
<span class="sd">        leave_parametrized (bool, optional): leave the attribute :attr:`tensor_name` parametrized.</span>
<span class="sd">            Default: ``True``</span>

<span class="sd">    Returns:</span>
<span class="sd">        Module: module</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: if ``module[tensor_name]`` is not parametrized</span>
<span class="sd">        ValueError: if ``leave_parametrized=False`` and the parametrization depends on several tensors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_parametrized</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">tensor_name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Module </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> does not have a parametrization on </span><span class="si">{</span><span class="n">tensor_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Fetch the original tensor</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">,</span> <span class="n">ModuleDict</span><span class="p">)</span>  <span class="c1"># Make mypy happy</span>
    <span class="n">parametrizations</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">[</span><span class="n">tensor_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">parametrizations</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">:</span>
        <span class="n">original</span> <span class="o">=</span> <span class="n">parametrizations</span><span class="o">.</span><span class="n">original</span>
        <span class="k">if</span> <span class="n">leave_parametrized</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">t</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">tensor_name</span><span class="p">)</span>
            <span class="c1"># We know they have the same dtype because we have checked this when registering the</span>
            <span class="c1"># parametrizations. As such, we can use set_</span>
            <span class="c1"># We do this so that the parameter does not to change the id()</span>
            <span class="c1"># This way the user does not need to update the optimizer</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">original</span><span class="p">)</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
                    <span class="n">_maybe_set</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_maybe_set</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="c1"># TODO: Fix this for tensor subclasses that are parameters:</span>
                        <span class="c1"># RuntimeError: set_storage is not allowed on a Tensor created from .data or .detach().</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                            <span class="s2">&quot;Calling remove_parametrizations() with leave_parametrized=True &quot;</span>
                            <span class="s2">&quot;for a parameter that is an instance of a tensor subclass requires &quot;</span>
                            <span class="s2">&quot;set_() to be implemented correctly for the tensor subclass.&quot;</span>
                            <span class="s2">&quot;Alternatively, one can opt into the swap_tensors path&quot;</span>
                            <span class="s2">&quot;Either set leave_parametrized=False or provide a working implementation&quot;</span>
                            <span class="s2">&quot;for set_() in the tensor subclass or set &quot;</span>
                            <span class="s2">&quot;torch.__future__.set_swap_module_params_on_conversion(True).&quot;</span>
                        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">leave_parametrized</span><span class="p">:</span>
            <span class="c1"># We cannot use no_grad because we need to know whether one or more</span>
            <span class="c1"># original tensors required grad</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">tensor_name</span><span class="p">)</span>
            <span class="c1"># We&#39;ll have to trust the user to add it to the optimizer</span>
            <span class="n">original</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">requires_grad</span> <span class="k">else</span> <span class="n">t</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot leave unparametrized (`leave_parametrized=False`) a tensor &quot;</span>
                <span class="s2">&quot;that is parametrized in terms of a sequence of tensors.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Delete the property that manages the parametrization</span>
    <span class="nb">delattr</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">tensor_name</span><span class="p">)</span>
    <span class="c1"># Delete the ParametrizationList</span>
    <span class="k">del</span> <span class="n">module</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">[</span><span class="n">tensor_name</span><span class="p">]</span>

    <span class="c1"># Restore the parameter / buffer into the main class</span>
    <span class="n">_register_parameter_or_buffer</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">tensor_name</span><span class="p">,</span> <span class="n">original</span><span class="p">)</span>

    <span class="c1"># Roll back the parametrized class if no other buffer or parameter</span>
    <span class="c1"># is currently parametrized in this class</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_parametrized</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;parametrizations&quot;</span><span class="p">)</span>
        <span class="c1"># Restore class</span>
        <span class="n">orig_cls</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">module</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">orig_cls</span>
    <span class="k">return</span> <span class="n">module</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">type_before_parametrizations</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return the module type before parametrizations were applied and if not, then it returns the module type.</span>

<span class="sd">    Args:</span>
<span class="sd">        module (nn.Module): module to get type of</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_parametrized</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">module</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">transfer_parametrizations_and_params</span><span class="p">(</span>
    <span class="n">from_module</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span>
    <span class="n">to_module</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span>
    <span class="n">tensor_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Module</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Transfer parametrizations and the parameters they parametrize from :attr:`from_module` to :attr:`to_module`.</span>

<span class="sd">    If :attr:`tensor_name` is specified, only transfers the specified parameter, otherwise</span>
<span class="sd">    transfers all parametrized parameters. If those parameters do not exist in to_module, it will create them.</span>
<span class="sd">    Does nothing if from_module is not parametrized.</span>

<span class="sd">    Args:</span>
<span class="sd">        from_module (nn.Module): module to transfer from</span>
<span class="sd">        to_module (nn.Module): module to transfer to</span>
<span class="sd">        tensor_name (str, optional): parameter to transfer</span>

<span class="sd">    Returns:</span>
<span class="sd">        Module: to_module</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_parametrized</span><span class="p">(</span><span class="n">from_module</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">from_module</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">,</span> <span class="n">ModuleDict</span><span class="p">)</span>  <span class="c1"># for mypy</span>

        <span class="c1"># get list of all params or the single param to transfer</span>
        <span class="n">parameters_to_transfer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">ModuleDict</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">from_module</span><span class="o">.</span><span class="n">parametrizations</span> <span class="k">if</span> <span class="n">tensor_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">tensor_name</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parameters_to_transfer</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span>  <span class="c1"># for mypy</span>
        <span class="k">for</span> <span class="n">parameter_name</span> <span class="ow">in</span> <span class="n">parameters_to_transfer</span><span class="p">:</span>
            <span class="c1"># initialize the to-be-transferred param in to_module if it doesn&#39;t exist already</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">to_module</span><span class="p">,</span> <span class="n">parameter_name</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span>
                    <span class="n">to_module</span><span class="p">,</span>
                    <span class="n">parameter_name</span><span class="p">,</span>
                    <span class="n">Parameter</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">from_module</span><span class="p">,</span> <span class="n">parameter_name</span><span class="p">)),</span>
                <span class="p">)</span>

            <span class="c1"># apply the params&#39;s parametrizations to to_module</span>
            <span class="k">for</span> <span class="n">param_func</span> <span class="ow">in</span> <span class="n">from_module</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">[</span><span class="n">parameter_name</span><span class="p">]:</span>
                <span class="n">register_parametrization</span><span class="p">(</span><span class="n">to_module</span><span class="p">,</span> <span class="n">parameter_name</span><span class="p">,</span> <span class="n">param_func</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_module</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">,</span> <span class="n">ModuleDict</span><span class="p">)</span>  <span class="c1"># for mypy</span>

            <span class="c1"># make values match, original values can be stored in either original or</span>
            <span class="c1"># original0, original1..., need to check both cases</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">from_module</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">[</span><span class="n">parameter_name</span><span class="p">],</span> <span class="s2">&quot;original&quot;</span><span class="p">):</span>
                <span class="n">to_module</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">[</span>
                    <span class="n">parameter_name</span>
                <span class="p">]</span><span class="o">.</span><span class="n">original</span> <span class="o">=</span> <span class="n">from_module</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">[</span><span class="n">parameter_name</span><span class="p">]</span><span class="o">.</span><span class="n">original</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">orig_num</span> <span class="o">=</span> <span class="s2">&quot;original&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
                <span class="c1"># loop through each original# until all values have been set</span>
                <span class="k">while</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">from_module</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">[</span><span class="n">parameter_name</span><span class="p">],</span> <span class="n">orig_num</span><span class="p">):</span>
                    <span class="nb">setattr</span><span class="p">(</span>
                        <span class="n">to_module</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">[</span><span class="n">parameter_name</span><span class="p">],</span>
                        <span class="n">orig_num</span><span class="p">,</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">from_module</span><span class="o">.</span><span class="n">parametrizations</span><span class="p">[</span><span class="n">parameter_name</span><span class="p">],</span> <span class="n">orig_num</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">orig_num</span> <span class="o">=</span> <span class="s2">&quot;original&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">to_module</span>
</pre></div>

                </article>
              
              
              
                <footer class="bd-footer-article">
                  <div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item">
<div class="feedback">
  
<div class="rating">
    Rate this Page
    <div class="stars">
        
        <span class="star" data-value="1">★</span>
        
        <span class="star" data-value="2">★</span>
        
        <span class="star" data-value="3">★</span>
        
        <span class="star" data-value="4">★</span>
        
        <span class="star" data-value="5">★</span>
        
    </div>
</div>

  <div class="feedback-send">
    <button class="feedback-btn" onclick="openGitHubIssue()">Send Feedback</button>
  </div>
</div>
</div>
  
</div>
                </footer>
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>


  <footer class="bd-footer">
    
    <div class="bd-footer__inner bd-page-width">
      
        <div class="footer-items__start">
          
            <div class="footer-item">

  <p class="copyright">
    
      © Copyright PyTorch Contributors.
      <br/>
    
  </p>
</div>
          
            <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.0.
    <br/>
  </p>
</div>
          
        </div>
      
    
    
      <div class="footer-items__end">
        
          <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
        
      </div>
    
   </div>
   

   <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
      <div class="container">
        <div class="row">
          <div class="col-md-4 text-center">
            <h2>Docs</h2>
            <p>Access comprehensive developer documentation for PyTorch</p>
            <a class="with-right-arrow" href="">View Docs</a>
          </div>

          <div class="col-md-4 text-center">
            <h2>Tutorials</h2>
            <p>Get in-depth tutorials for beginners and advanced developers</p>
            <a class="with-right-arrow" href="">View Tutorials</a>
          </div>

          <div class="col-md-4 text-center">
            <h2>Resources</h2>
            <p>Find development resources and get your questions answered</p>
            <a class="with-right-arrow" href="">View Resources</a>
          </div>
        </div>
      </div>
  </div>

  <footer class="site-footer">
      <div class="container footer-container">
        <div class="footer-logo-wrapper">
          <a href="" class="footer-logo"></a>
        </div>

        <div class="footer-links-wrapper">
          <div class="footer-links-col">
            <ul>
              <li class="list-title"><a href="">PyTorch</a></li>
              <li><a href="">Get Started</a></li>
              <li><a href="">Features</a></li>
              <li><a href="">Ecosystem</a></li>
              <li><a href="">Blog</a></li>
              <li><a href="">Contributing</a></li>
            </ul>
          </div>

          <div class="footer-links-col">
            <ul>
              <li class="list-title"><a href="">Resources</a></li>
              <li><a href="">Tutorials</a></li>
              <li><a href="">Docs</a></li>
              <li><a href="" target="_blank">Discuss</a></li>
              <li><a href="" target="_blank">Github Issues</a></li>
              <li><a href="" target="_blank">Brand Guidelines</a></li>
            </ul>
          </div>

          <div class="footer-links-col">
            <ul>
              <li class="list-title">Stay up to date</li>
              <li><a href="" target="_blank">Facebook</a></li>
              <li><a href="" target="_blank">Twitter</a></li>
              <li><a href="" target="_blank">YouTube</a></li>
              <li><a href="" target="_blank">LinkedIn</a></li>
            </ul>
            </div>

          <div class="footer-links-col">
            <ul>
              <li class="list-title">PyTorch Podcasts</li>
              <li><a href="" target="_blank">Spotify</a></li>
              <li><a href="" target="_blank">Apple</a></li>
              <li><a href="" target="_blank">Google</a></li>
              <li><a href="" target="_blank">Amazon</a></li>
            </ul>
           </div>
          </div>

          <div class="privacy-policy">
            <ul>
              <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
              <li class="privacy-policy-links">|</li>
              <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
            </ul>
          </div>
          <div class="copyright">
          <p>© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
            For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
            <a href="https://www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
            project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
            please see <a href="https://www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
        </div>
       </div>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../../_static/img/pytorch-x.svg">
  </div>
</div>
  </footer>


  </body>
</html>