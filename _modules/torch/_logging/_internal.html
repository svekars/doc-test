
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>torch._logging._internal &#8212; PyTorch main documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=949a1ff5" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/katex-math.css?v=91adb8b6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/jit.css?v=8de1ea5d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=3ccf5357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom2.css?v=189c4a6a" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../_static/documentation_options.js?v=53c08c8d"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=940804e7"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/torch/_logging/_internal';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="main (2.7.0a0+git74cfb4f )" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>

          <li class="main-menu-item">
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Learn
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class=dropdown-title>Get Started</span>
                  <p>Run PyTorch locally or get started quickly with one of the supported cloud platforms</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Tutorials</span>
                  <p>Whats new in PyTorch tutorials</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Learn the Basics</span>
                  <p>Familiarize yourself with PyTorch concepts and modules</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch Recipes</span>
                  <p>Bite-size, ready-to-deploy PyTorch code examples</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Intro to PyTorch - YouTube Series</span>
                  <p>Master PyTorch basics with our engaging YouTube tutorial series</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Ecosystem
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Tools</span>
                  <p>Learn about the tools and frameworks in the PyTorch Ecosystem</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class=dropdown-title>Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="" target="_blank">
                  <span class=dropdown-title>Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class=dropdown-title>Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Contributor Awards - 2024</span>
                  <p>Award winners announced at this year's PyTorch Conference</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Edge
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">About PyTorch Edge</span>
                  <p>Build innovative and privacy-aware AI experiences for edge devices</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">ExecuTorch</span>
                  <p>End-to-end solution for enabling on-device inference capabilities across mobile and edge devices</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">ExecuTorch Docs</span>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch</span>
                  <p>Explore the documentation for comprehensive guidance on how to use PyTorch</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch Domains</span>
                  <p>Read the PyTorch Domains documentation to learn more about domain-specific libraries</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Blogs & News
              lnhetrlnle</a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch Blog</span>
                  <p>Catch up on the latest technical news and happenings</p>
                </a>
                 <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Community Blog</span>
                  <p>Stories from the PyTorch ecosystem</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Videos</span>
                  <p>Learn about the latest PyTorch tutorials, new, and more </p>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Newsletter</span>
                  <p>Stay up-to-date with the latest updates</p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                About
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn more about the PyTorch Foundation</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Governing Board</span>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Cloud Credit Program</span>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Technical Advisory Council</span>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Staff</span>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Contact Us</span>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
            <div class="no-dropdown">
              <a href="" data-cta="join">
                Become a Member
              </a>
            </div>
          </li>
          <li>
           <div class="main-menu-item">
             <a href="" class="github-icon">
             </a>
           </div>
          </li>
          <!--- TODO: This block adds the search icon to the nav bar. We will enable it later.
          <li>
            <div class="main-menu-item">
             <a href="" class="search-icon">
             </a>
            </div>
          </li>
          --->
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>


  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
    <div class="navbar-header-items__start" style="display: flex; align-items: center; justify-content: flex-start;">
    <div class="navbar-item">
      <a class="nav-link nav-internal" href="/index.html">Home</a></div>
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/pytorch-logo-dark-unstable.png" class="logo__image only-light" alt="PyTorch main documentation - Home"/>
    <img src="../../../_static/pytorch-logo-dark-unstable.png" class="logo__image only-dark pst-js-only" alt="PyTorch main documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../python-api/index.html">
    Python API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../notes/index.html">
    Developer Notes
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../community/index.html">
    Community
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../lang-bindings/index.html">
    Language Bindings
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../python-api/index.html">
    Python API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../notes/index.html">
    Developer Notes
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../community/index.html">
    Community
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../lang-bindings/index.html">
    Language Bindings
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../../torch.html" class="nav-link">torch</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">torch._logging._internal</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for torch._logging._internal</h1><div class="highlight"><pre>
<span></span><span class="c1"># mypy: allow-untyped-defs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib.util</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">weakref</span><span class="w"> </span><span class="kn">import</span> <span class="n">WeakSet</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch._logging.structured</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch._guards</span><span class="w"> </span><span class="kn">import</span> <span class="n">CompileId</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch._utils_internal</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_trace_structured_event</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils._traceback</span><span class="w"> </span><span class="kn">import</span> <span class="n">CapturedTraceback</span>


<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># This is a synthetic logger which doesn&#39;t correspond to an actual logger,</span>
<span class="c1"># but handles all of our &quot;tracing&quot; logging, which is structured and doesn&#39;t go</span>
<span class="c1"># to stderr but always goes to a dedicated log file.  We don&#39;t put these</span>
<span class="c1"># loggers in the classic module hierarchy, because we don&#39;t want a suppression</span>
<span class="c1"># of logs to also cause a trace to get suppressed (traces typically are not</span>
<span class="c1"># collected, unless we are in prod, in which case they always are collected.)</span>
<span class="c1">#</span>
<span class="c1"># TODO: Maybe we should allow for some sub-hierarchy so you can control which</span>
<span class="c1"># traces you want to collect, for performance reasons.</span>
<span class="c1">#</span>
<span class="c1"># See https://docs.google.com/document/d/1CX_hJ0PNy9f3R1y8TJrfkSeLkvGjjjLU84BSXgS2AZ8/edit</span>
<span class="n">trace_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;torch.__trace&quot;</span><span class="p">)</span>

<span class="n">DEFAULT_LOG_LEVEL</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span>
<span class="n">LOG_ENV_VAR</span> <span class="o">=</span> <span class="s2">&quot;TORCH_LOGS&quot;</span>
<span class="n">LOG_OUT_ENV_VAR</span> <span class="o">=</span> <span class="s2">&quot;TORCH_LOGS_OUT&quot;</span>
<span class="n">LOG_FORMAT_ENV_VAR</span> <span class="o">=</span> <span class="s2">&quot;TORCH_LOGS_FORMAT&quot;</span>
<span class="n">TRACE_ENV_VAR</span> <span class="o">=</span> <span class="s2">&quot;TORCH_TRACE&quot;</span>

<span class="n">LOG_TRACE_HANDLER</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;LazyTraceHandler&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LogRegistry</span><span class="p">:</span>
    <span class="c1"># shorthand name to log qualified name</span>
    <span class="c1"># Note: this only contains loggers registered</span>
    <span class="c1"># from register_log</span>
    <span class="c1"># e.g. &quot;dynamo&quot; -&gt; &quot;torch._dynamo&quot;</span>
    <span class="n">log_alias_to_log_qnames</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="c1"># artifact logger qualified names,</span>
    <span class="c1"># this is populated lazily, as calls to getArtifactLogger</span>
    <span class="c1"># currently formatted as &lt;module&gt;.__&lt;artifact_name&gt;</span>
    <span class="c1"># e.g. &quot;torch._dynamo.convert_frame.__guards&quot;</span>
    <span class="n">artifact_log_qnames</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">set</span><span class="p">)</span>

    <span class="c1"># child logs of registered logs if specified via open</span>
    <span class="c1"># registration by the user (ie placing &quot;torch._dynamo.output_graph&quot; in the env var)</span>
    <span class="c1"># these need to be tracked so their levels can be reset properly</span>
    <span class="c1"># e.g. &quot;torch._dynamo.output_graph&quot;</span>
    <span class="n">child_log_qnames</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">set</span><span class="p">)</span>

    <span class="c1"># artifact names, populated by register_artifact</span>
    <span class="c1"># e.g. &quot;guards&quot;</span>
    <span class="n">artifact_names</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">set</span><span class="p">)</span>

    <span class="c1"># Artifacts that should be visible by default in the error message</span>
    <span class="n">visible_artifacts</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">set</span><span class="p">)</span>

    <span class="c1"># A short description of each artifact</span>
    <span class="n">artifact_descriptions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="c1"># artifacts which are not displayed unless explicitly named in the</span>
    <span class="c1"># settings. Ex. output_code is NOT displayed even if the inductor</span>
    <span class="c1"># log level is set to DEBUG. It must be explicitly named in the settings</span>
    <span class="n">off_by_default_artifact_names</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">set</span><span class="p">)</span>

    <span class="c1"># logging format string for artifacts</span>
    <span class="n">artifact_log_formatters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_artifact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">artifact_names</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">alias</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_alias_to_log_qnames</span>

    <span class="c1"># register a log with an alias</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">log_qnames</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">log_qnames</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">log_qnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">log_qnames</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_alias_to_log_qnames</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_qnames</span>

    <span class="c1"># register an artifact name</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_artifact_name</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">visible</span><span class="p">,</span> <span class="n">off_by_default</span><span class="p">,</span> <span class="n">log_format</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">artifact_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">visible</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visible_artifacts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">artifact_descriptions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>

        <span class="c1"># if off by default, don&#39;t enable it</span>
        <span class="c1"># when log_name&#39;s log_level is set to DEBUG</span>
        <span class="k">if</span> <span class="n">off_by_default</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">off_by_default_artifact_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log_format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">artifact_log_formatters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">log_format</span><span class="p">)</span>

    <span class="c1"># register the qualified name of an artifact log</span>
    <span class="c1"># this is needed to know which logs need to be reset</span>
    <span class="c1"># whenever the log_state is changed</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_artifact_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">artifact_log_qname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">artifact_log_qnames</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">artifact_log_qname</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register_child_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_qname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child_log_qnames</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">log_qname</span><span class="p">)</span>

    <span class="c1"># flattens all the qnames together (TODO: consider memoizing?)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_log_qnames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">qname</span>
            <span class="k">for</span> <span class="n">qnames</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_alias_to_log_qnames</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">qname</span> <span class="ow">in</span> <span class="n">qnames</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_artifact_log_qnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">artifact_log_qnames</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_child_log_qnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_log_qnames</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_off_by_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">artifact_qname</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">artifact_qname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">off_by_default_artifact_names</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LogState</span><span class="p">:</span>
    <span class="c1"># qualified log names -&gt; currently set log level</span>
    <span class="n">log_qname_to_level</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="c1"># the set of currently enabled artifacts</span>
    <span class="n">artifact_names</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">set</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">enable_artifact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">artifact_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">artifact_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">artifact_name</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_artifact_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">artifact_names</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">enable_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_qnames</span><span class="p">,</span> <span class="n">log_level</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">log_qnames</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">log_qnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">log_qnames</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">log_qname</span> <span class="ow">in</span> <span class="n">log_qnames</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_qname_to_level</span><span class="p">[</span><span class="n">log_qname</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_level</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_log_level_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns all qualified module names for which the user requested</span>
<span class="sd">        explicit logging settings.</span>

<span class="sd">        .. warning:</span>

<span class="sd">            This function used to return all loggers, regardless of whether</span>
<span class="sd">            or not the user specified them or not; it now only returns logs</span>
<span class="sd">            which were explicitly mentioned by the user (and torch, which</span>
<span class="sd">            always is implicitly requested when we initialize our logging</span>
<span class="sd">            subsystem.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_qname_to_level</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_qname_to_level</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">artifact_names</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>


<span class="n">log_registry</span> <span class="o">=</span> <span class="n">LogRegistry</span><span class="p">()</span>
<span class="n">log_state</span> <span class="o">=</span> <span class="n">LogState</span><span class="p">()</span>

<span class="c1"># sample usage: torch._logging.set_logs(**torch._logging.DEFAULT_LOGGING)</span>
<span class="n">DEFAULT_LOGGING</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;dynamo&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="s2">&quot;aot&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="s2">&quot;inductor&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="s2">&quot;fsdp&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="s2">&quot;ddp_graphs&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;graph_breaks&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;guards&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;recompiles&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;dynamic&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="set_logs">
<a class="viewcode-back" href="../../../python-api/torch._logging.set_logs.html#torch._logging.set_logs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">set_logs</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="nb">all</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dynamo</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">aot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">autograd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dynamic</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">inductor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">distributed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">c10d</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ddp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fsdp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dtensor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">onnx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bytecode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">aot_graphs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">aot_joint_graph</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">ddp_graphs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">graph</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">graph_code</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">graph_breaks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">graph_sizes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">guards</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">recompiles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">recompiles_verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">trace_source</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">trace_call</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">trace_bytecode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">output_code</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">kernel_code</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">schedule</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">perf_hints</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">pre_grad_graphs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">post_grad_graphs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">onnx_diagnostics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">fusion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">overlap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">export</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">modules</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cudagraphs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">sym_node</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">compiled_autograd</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">compiled_autograd_verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">cudagraph_static_inputs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">benchmarking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">graph_region_expansion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the log level for individual components and toggles individual log</span>
<span class="sd">    artifact types.</span>

<span class="sd">    .. warning:: This feature is a prototype and may have compatibility</span>
<span class="sd">        breaking changes in the future.</span>

<span class="sd">    .. note:: The ``TORCH_LOGS`` environment variable has complete precedence</span>
<span class="sd">        over this function, so if it was set, this function does nothing.</span>

<span class="sd">    A component is a set of related features in PyTorch. All of the log</span>
<span class="sd">    messages emitted from a given component have their own log levels. If the</span>
<span class="sd">    log level of a particular message has priority greater than or equal to its</span>
<span class="sd">    component&#39;s log level setting, it is emitted. Otherwise, it is suppressed.</span>
<span class="sd">    This allows you to, for instance, silence large groups of log messages that</span>
<span class="sd">    are not relevant to you and increase verbosity of logs for components that</span>
<span class="sd">    are relevant. The expected log level values, ordered from highest to lowest</span>
<span class="sd">    priority, are:</span>

<span class="sd">        * ``logging.CRITICAL``</span>
<span class="sd">        * ``logging.ERROR``</span>
<span class="sd">        * ``logging.WARNING``</span>
<span class="sd">        * ``logging.INFO``</span>
<span class="sd">        * ``logging.DEBUG``</span>
<span class="sd">        * ``logging.NOTSET``</span>

<span class="sd">    See documentation for the Python ``logging`` module for more information on</span>
<span class="sd">    log levels: `&lt;https://docs.python.org/3/library/logging.html#logging-levels&gt;`_</span>

<span class="sd">    An artifact is a particular type of log message. Each artifact is assigned</span>
<span class="sd">    to a parent component. A component can emit many different kinds of</span>
<span class="sd">    artifacts. In general, an artifact is emitted if either its corresponding</span>
<span class="sd">    setting in the argument list below is turned on or if its parent component</span>
<span class="sd">    is set to a log level less than or equal to the log level of the artifact.</span>

<span class="sd">    Keyword args:</span>
<span class="sd">        all (:class:`Optional[int]`):</span>
<span class="sd">            The default log level for all components. Default: ``logging.WARN``</span>

<span class="sd">        dynamo (:class:`Optional[int]`):</span>
<span class="sd">            The log level for the TorchDynamo component. Default: ``logging.WARN``</span>

<span class="sd">        aot (:class:`Optional[int]`):</span>
<span class="sd">            The log level for the AOTAutograd component. Default: ``logging.WARN``</span>

<span class="sd">        autograd (:class:`Optional[int]`):</span>
<span class="sd">            The log level for autograd. Default: ``logging.WARN``</span>

<span class="sd">        inductor (:class:`Optional[int]`):</span>
<span class="sd">            The log level for the TorchInductor component. Default: ``logging.WARN``</span>

<span class="sd">        dynamic (:class:`Optional[int]`):</span>
<span class="sd">            The log level for dynamic shapes. Default: ``logging.WARN``</span>

<span class="sd">        distributed (:class:`Optional[int]`):</span>
<span class="sd">            Whether to log c10d communication operations and other debug info from PyTorch Distributed components.</span>
<span class="sd">            Default: ``logging.WARN``</span>

<span class="sd">        c10d (:class:`Optional[int]`):</span>
<span class="sd">            Whether to log c10d communication operations related debug info in PyTorch Distributed components.</span>
<span class="sd">            Default: ``logging.WARN``</span>

<span class="sd">        ddp (:class:`Optional[int]`):</span>
<span class="sd">            Whether to log debug info related to ``DistributedDataParallel``(DDP) from PyTorch Distributed components.</span>
<span class="sd">            Default: ``logging.WARN``</span>

<span class="sd">        fsdp (:class:`Optional[int]`):</span>
<span class="sd">            Whether to log debug info related to ``FullyShardedDataParallel``(FSDP) in PyTorch Distributed components.</span>
<span class="sd">            Default: ``logging.WARN``</span>

<span class="sd">        dtensor (:class:`Optional[int]`):</span>
<span class="sd">            Whether to log debug info related to ``DTensor``(DTensor) in PyTorch Distributed components.</span>
<span class="sd">            Default: ``logging.WARN``</span>

<span class="sd">        onnx (:class:`Optional[int]`):</span>
<span class="sd">            The log level for the ONNX exporter component. Default: ``logging.WARN``</span>

<span class="sd">        bytecode (:class:`bool`):</span>
<span class="sd">            Whether to emit the original and generated bytecode from TorchDynamo.</span>
<span class="sd">            Default: ``False``</span>

<span class="sd">        aot_graphs (:class:`bool`):</span>
<span class="sd">            Whether to emit the graphs generated by AOTAutograd. Default: ``False``</span>

<span class="sd">        aot_joint_graph (:class:`bool`):</span>
<span class="sd">            Whether to emit the joint forward-backward graph generated by AOTAutograd. Default: ``False``</span>

<span class="sd">        ddp_graphs (:class:`bool`):</span>
<span class="sd">            Whether to emit graphs generated by DDPOptimizer. Default: ``False``</span>

<span class="sd">        graph (:class:`bool`):</span>
<span class="sd">            Whether to emit the graph captured by TorchDynamo in tabular format.</span>
<span class="sd">            Default: ``False``</span>

<span class="sd">        graph_code (:class:`bool`):</span>
<span class="sd">            Whether to emit the python source of the graph captured by TorchDynamo.</span>
<span class="sd">            Default: ``False``</span>

<span class="sd">        graph_breaks (:class:`bool`):</span>
<span class="sd">            Whether to emit the graph breaks encountered by TorchDynamo.</span>
<span class="sd">            Default: ``False``</span>

<span class="sd">        graph_sizes (:class:`bool`):</span>
<span class="sd">            Whether to emit tensor sizes of the graph captured by TorchDynamo.</span>
<span class="sd">            Default: ``False``</span>

<span class="sd">        guards (:class:`bool`):</span>
<span class="sd">            Whether to emit the guards generated by TorchDynamo for each compiled</span>
<span class="sd">            function. Default: ``False``</span>

<span class="sd">        recompiles (:class:`bool`):</span>
<span class="sd">            Whether to emit a guard failure reason and message every time</span>
<span class="sd">            TorchDynamo recompiles a function. Default: ``False``</span>

<span class="sd">        recompiles_verbose (:class:`bool`):</span>
<span class="sd">            Whether to emit all guard failure reasons when TorchDynamo recompiles</span>
<span class="sd">            a function, even those that are not actually run. Default: ``False``</span>

<span class="sd">        trace_source (:class:`bool`):</span>
<span class="sd">            Whether to emit when TorchDynamo begins tracing a new line. Default: ``False``</span>

<span class="sd">        trace_call (:class:`bool`):</span>
<span class="sd">            Whether to emit detailed line location when TorchDynamo creates an FX node</span>
<span class="sd">            corresponding to function call. Python 3.11+ only. Default: ``False``</span>

<span class="sd">        trace_bytecode (:class:`bool`):</span>
<span class="sd">            Whether to emit bytecode instructions and traced stack state as TorchDynamo</span>
<span class="sd">            traces bytecode. Default: ``False``</span>

<span class="sd">        output_code (:class:`bool`):</span>
<span class="sd">            Whether to emit the TorchInductor output code on a per-graph basis. Default: ``False``</span>

<span class="sd">        kernel_code (:class:`bool`):</span>
<span class="sd">            Whether to emit the TorchInductor output code on a per-kernel bases. Default: ``False``</span>

<span class="sd">        schedule (:class:`bool`):</span>
<span class="sd">            Whether to emit the TorchInductor schedule. Default: ``False``</span>

<span class="sd">        perf_hints (:class:`bool`):</span>
<span class="sd">            Whether to emit the TorchInductor perf hints. Default: ``False``</span>

<span class="sd">        pre_grad_graphs (:class:`bool`):</span>
<span class="sd">            Whether to emit the graphs before inductor grad passes. Default: ``False``</span>

<span class="sd">        post_grad_graphs (:class:`bool`):</span>
<span class="sd">            Whether to emit the graphs generated by after post grad passes. Default: ``False``</span>

<span class="sd">        onnx_diagnostics (:class:`bool`):</span>
<span class="sd">            Whether to emit the ONNX exporter diagnostics in logging. Default: ``False``</span>

<span class="sd">        fusion (:class:`bool`):</span>
<span class="sd">            Whether to emit detailed Inductor fusion decisions. Default: ``False``</span>

<span class="sd">        overlap (:class:`bool`):</span>
<span class="sd">            Whether to emit detailed Inductor compute/comm overlap decisions. Default: ``False``</span>

<span class="sd">        sym_node (:class:`bool`):</span>
<span class="sd">            Whether to emit debug info for various SymNode opterations. Default: ``False``</span>

<span class="sd">        export (:class:`Optional[int]`):</span>
<span class="sd">            The log level for export. Default: ``logging.WARN``</span>

<span class="sd">        benchmarking (:class:`bool`):</span>
<span class="sd">            Whether to emit detailed Inductor benchmarking information. Default: ``False``</span>

<span class="sd">        modules (dict):</span>
<span class="sd">            This argument provides an alternate way to specify the above log</span>
<span class="sd">            component and artifact settings, in the format of a keyword args</span>
<span class="sd">            dictionary given as a single argument. There are two cases</span>
<span class="sd">            where this is useful (1) if a new log component or artifact has</span>
<span class="sd">            been registered but a keyword argument for it has not been added</span>
<span class="sd">            to this function and (2) if the log level for an unregistered module</span>
<span class="sd">            needs to be set. This can be done by providing the fully-qualified module</span>
<span class="sd">            name as the key, with the log level as the value. Default: ``None``</span>

<span class="sd">        cudagraph_static_inputs (:class:`bool`):</span>
<span class="sd">            Whether to emit debug info for cudagraph static input detection. Default: ``False``</span>

<span class="sd">        graph_region_expansion (:class:`bool`):</span>
<span class="sd">            Whether to emit the detailed steps of the duplicate graph region tracker expansion algorithm. Default: ``False``</span>


<span class="sd">    Example::</span>

<span class="sd">        &gt;&gt;&gt; # xdoctest: +SKIP</span>
<span class="sd">        &gt;&gt;&gt; import logging</span>

<span class="sd">        # The following changes the &quot;dynamo&quot; component to emit DEBUG-level</span>
<span class="sd">        # logs, and to emit &quot;graph_code&quot; artifacts.</span>

<span class="sd">        &gt;&gt;&gt; torch._logging.set_logs(dynamo=logging.DEBUG, graph_code=True)</span>

<span class="sd">        # The following enables the logs for a different module</span>

<span class="sd">        &gt;&gt;&gt; torch._logging.set_logs(modules={&quot;unregistered.module.name&quot;: logging.DEBUG})</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ignore if env var is set</span>
    <span class="k">if</span> <span class="n">LOG_ENV_VAR</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Using TORCH_LOGS environment variable for log settings, ignoring call to set_logs&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="n">log_state</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="n">modules</span> <span class="o">=</span> <span class="n">modules</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_logs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">modules</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>  <span class="c1"># type: ignore[union-attr]</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">log_registry</span><span class="o">.</span><span class="n">is_artifact</span><span class="p">(</span><span class="n">alias</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Expected bool to enable artifact </span><span class="si">{</span><span class="n">alias</span><span class="si">}</span><span class="s2">, received </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                    <span class="n">log_state</span><span class="o">.</span><span class="n">enable_artifact</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">log_registry</span><span class="o">.</span><span class="n">is_log</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span> <span class="ow">or</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">log_registry</span><span class="o">.</span><span class="n">child_log_qnames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">logging</span><span class="o">.</span><span class="n">_levelToName</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Unrecognized log level for log </span><span class="si">{</span><span class="n">alias</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">, valid level values &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;are: </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">logging</span><span class="o">.</span><span class="n">_levelToName</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="n">log_state</span><span class="o">.</span><span class="n">enable_log</span><span class="p">(</span>
                    <span class="n">log_registry</span><span class="o">.</span><span class="n">log_alias_to_log_qnames</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">alias</span><span class="p">),</span> <span class="n">val</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unrecognized log or artifact name passed to set_logs: </span><span class="si">{</span><span class="n">alias</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="n">_init_logs</span><span class="p">()</span>

    <span class="n">_set_logs</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">=</span><span class="nb">all</span><span class="p">,</span>
        <span class="n">dynamo</span><span class="o">=</span><span class="n">dynamo</span><span class="p">,</span>
        <span class="n">aot</span><span class="o">=</span><span class="n">aot</span><span class="p">,</span>
        <span class="n">autograd</span><span class="o">=</span><span class="n">autograd</span><span class="p">,</span>
        <span class="n">inductor</span><span class="o">=</span><span class="n">inductor</span><span class="p">,</span>
        <span class="n">dynamic</span><span class="o">=</span><span class="n">dynamic</span><span class="p">,</span>
        <span class="n">bytecode</span><span class="o">=</span><span class="n">bytecode</span><span class="p">,</span>
        <span class="n">aot_graphs</span><span class="o">=</span><span class="n">aot_graphs</span><span class="p">,</span>
        <span class="n">aot_joint_graph</span><span class="o">=</span><span class="n">aot_joint_graph</span><span class="p">,</span>
        <span class="n">ddp_graphs</span><span class="o">=</span><span class="n">ddp_graphs</span><span class="p">,</span>
        <span class="n">distributed</span><span class="o">=</span><span class="n">distributed</span><span class="p">,</span>
        <span class="n">c10d</span><span class="o">=</span><span class="n">c10d</span><span class="p">,</span>
        <span class="n">ddp</span><span class="o">=</span><span class="n">ddp</span><span class="p">,</span>
        <span class="n">fsdp</span><span class="o">=</span><span class="n">fsdp</span><span class="p">,</span>
        <span class="n">dtensor</span><span class="o">=</span><span class="n">dtensor</span><span class="p">,</span>
        <span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">,</span>
        <span class="n">graph_code</span><span class="o">=</span><span class="n">graph_code</span><span class="p">,</span>
        <span class="n">graph_breaks</span><span class="o">=</span><span class="n">graph_breaks</span><span class="p">,</span>
        <span class="n">graph_sizes</span><span class="o">=</span><span class="n">graph_sizes</span><span class="p">,</span>
        <span class="n">guards</span><span class="o">=</span><span class="n">guards</span><span class="p">,</span>
        <span class="n">recompiles</span><span class="o">=</span><span class="n">recompiles</span><span class="p">,</span>
        <span class="n">recompiles_verbose</span><span class="o">=</span><span class="n">recompiles_verbose</span><span class="p">,</span>
        <span class="n">trace_source</span><span class="o">=</span><span class="n">trace_source</span><span class="p">,</span>
        <span class="n">trace_call</span><span class="o">=</span><span class="n">trace_call</span><span class="p">,</span>
        <span class="n">trace_bytecode</span><span class="o">=</span><span class="n">trace_bytecode</span><span class="p">,</span>
        <span class="n">output_code</span><span class="o">=</span><span class="n">output_code</span><span class="p">,</span>
        <span class="n">kernel_code</span><span class="o">=</span><span class="n">kernel_code</span><span class="p">,</span>
        <span class="n">schedule</span><span class="o">=</span><span class="n">schedule</span><span class="p">,</span>
        <span class="n">perf_hints</span><span class="o">=</span><span class="n">perf_hints</span><span class="p">,</span>
        <span class="n">pre_grad_graphs</span><span class="o">=</span><span class="n">pre_grad_graphs</span><span class="p">,</span>
        <span class="n">post_grad_graphs</span><span class="o">=</span><span class="n">post_grad_graphs</span><span class="p">,</span>
        <span class="n">onnx</span><span class="o">=</span><span class="n">onnx</span><span class="p">,</span>
        <span class="n">onnx_diagnostics</span><span class="o">=</span><span class="n">onnx_diagnostics</span><span class="p">,</span>
        <span class="n">fusion</span><span class="o">=</span><span class="n">fusion</span><span class="p">,</span>
        <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span>
        <span class="n">sym_node</span><span class="o">=</span><span class="n">sym_node</span><span class="p">,</span>
        <span class="n">export</span><span class="o">=</span><span class="n">export</span><span class="p">,</span>
        <span class="n">cudagraphs</span><span class="o">=</span><span class="n">cudagraphs</span><span class="p">,</span>
        <span class="n">compiled_autograd</span><span class="o">=</span><span class="n">compiled_autograd</span><span class="p">,</span>
        <span class="n">compiled_autograd_verbose</span><span class="o">=</span><span class="n">compiled_autograd_verbose</span><span class="p">,</span>
        <span class="n">cudagraph_static_inputs</span><span class="o">=</span><span class="n">cudagraph_static_inputs</span><span class="p">,</span>
        <span class="n">benchmarking</span><span class="o">=</span><span class="n">benchmarking</span><span class="p">,</span>
        <span class="n">graph_region_expansion</span><span class="o">=</span><span class="n">graph_region_expansion</span><span class="p">,</span>
    <span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">get_loggers</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns: a list of all registered loggers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">qname</span><span class="p">)</span> <span class="k">for</span> <span class="n">qname</span> <span class="ow">in</span> <span class="n">log_registry</span><span class="o">.</span><span class="n">get_log_qnames</span><span class="p">()]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">register_log</span><span class="p">(</span><span class="n">setting_name</span><span class="p">,</span> <span class="n">log_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enables a log to be controlled by the env var and user API with the setting_name</span>
<span class="sd">    Args:</span>
<span class="sd">        setting_name:  the shorthand name used in the env var and user API</span>
<span class="sd">        log_name:  the log name that the setting_name is associated with</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log_registry</span><span class="o">.</span><span class="n">register_log</span><span class="p">(</span><span class="n">setting_name</span><span class="p">,</span> <span class="n">log_name</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">register_artifact</span><span class="p">(</span>
    <span class="n">setting_name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">off_by_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log_format</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enables an artifact to be controlled by the env var and user API with name</span>
<span class="sd">    Args:</span>
<span class="sd">        setting_name: the shorthand name used in the env var and user API</span>
<span class="sd">        description: A description of what this outputs</span>
<span class="sd">        visible: Whether it gets suggested to users by default</span>
<span class="sd">        off_by_default: whether this artifact should be logged when the ancestor loggers</span>
<span class="sd">            are enabled at level DEBUG</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log_registry</span><span class="o">.</span><span class="n">register_artifact_name</span><span class="p">(</span>
        <span class="n">setting_name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">visible</span><span class="p">,</span> <span class="n">off_by_default</span><span class="p">,</span> <span class="n">log_format</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">getArtifactLogger</span><span class="p">(</span><span class="n">module_qname</span><span class="p">,</span> <span class="n">artifact_name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">artifact_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">log_registry</span><span class="o">.</span><span class="n">artifact_names</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Artifact name: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">artifact_name</span><span class="p">)</span><span class="si">}</span><span class="s2"> not registered,&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;please call register_artifact(</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">artifact_name</span><span class="p">)</span><span class="si">}</span><span class="s2">) in torch._logging.registrations.&quot;</span>
        <span class="p">)</span>
    <span class="n">qname</span> <span class="o">=</span> <span class="n">module_qname</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.__</span><span class="si">{</span><span class="n">artifact_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">qname</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">artifact_name</span> <span class="o">=</span> <span class="n">artifact_name</span>  <span class="c1"># type: ignore[attr-defined]</span>
    <span class="n">log_registry</span><span class="o">.</span><span class="n">register_artifact_log</span><span class="p">(</span><span class="n">qname</span><span class="p">)</span>
    <span class="n">configure_artifact_log</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">log</span>


<span class="n">INCR_VERBOSITY_CHAR</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
<span class="n">DECR_VERBOSITY_CHAR</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
<span class="n">VERBOSITY_REGEX</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;(&quot;</span>
    <span class="o">+</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">INCR_VERBOSITY_CHAR</span><span class="p">),</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">DECR_VERBOSITY_CHAR</span><span class="p">)])</span>
    <span class="o">+</span> <span class="s2">&quot;?)&quot;</span>
<span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">configure_artifact_log</span><span class="p">(</span><span class="n">log</span><span class="p">):</span>
    <span class="c1"># If the artifact is off by default, then it should only be logged when explicitly</span>
    <span class="c1"># enabled; set propagate to False so that this artifact is not propagated</span>
    <span class="c1"># to its ancestor logger</span>
    <span class="k">if</span> <span class="n">log_registry</span><span class="o">.</span><span class="n">is_off_by_default</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">artifact_name</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># enable artifact logging when explicitly enabled</span>
    <span class="k">if</span> <span class="n">log_state</span><span class="o">.</span><span class="n">is_artifact_enabled</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">artifact_name</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">True</span>


<span class="c1"># match a comma separated list of loggable names (whitespace allowed after commas)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_gen_settings_regex</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;((\+|-)?[\w\.]+,\s*)*(\+|-)?[\w\.]+?&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_validate_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">_gen_settings_regex</span><span class="p">(),</span> <span class="n">settings</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">help_message</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pad_to</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">length</span>
        <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">printed_artifacts</span> <span class="o">=</span> <span class="n">log_registry</span><span class="o">.</span><span class="n">artifact_names</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">printed_artifacts</span> <span class="o">=</span> <span class="n">log_registry</span><span class="o">.</span><span class="n">visible_artifacts</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">heading</span> <span class="o">=</span> <span class="s2">&quot;All registered names&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">heading</span> <span class="o">=</span> <span class="s2">&quot;Visible registered names (use TORCH_LOGS=&#39;+help&#39; for full list)&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">log_registry</span><span class="o">.</span><span class="n">log_alias_to_log_qnames</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pad_to</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">log_registry</span><span class="o">.</span><span class="n">artifact_descriptions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">printed_artifacts</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">setting_info</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="n">examples</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Examples:</span>
<span class="s2">  TORCH_LOGS=&quot;+dynamo,aot&quot; will set the log level of TorchDynamo to</span>
<span class="s2">  logging.DEBUG and AOT to logging.INFO</span>

<span class="s2">  TORCH_LOGS=&quot;-dynamo,+inductor&quot; will set the log level of TorchDynamo to</span>
<span class="s2">  logging.ERROR and TorchInductor to logging.DEBUG</span>

<span class="s2">  TORCH_LOGS=&quot;aot_graphs&quot; will enable the aot_graphs artifact</span>

<span class="s2">  TORCH_LOGS=&quot;+dynamo,schedule&quot; will enable set the log level of TorchDynamo</span>
<span class="s2">  to logging.DEBUG and enable the schedule artifact</span>

<span class="s2">  TORCH_LOGS=&quot;+some.random.module,schedule&quot; will set the log level of</span>
<span class="s2">  some.random.module to logging.DEBUG and enable the schedule artifact</span>

<span class="s2">  TORCH_LOGS_FORMAT=&quot;</span><span class="si">%(levelname)s</span><span class="s2">: </span><span class="si">%(message)s</span><span class="s2">&quot; or any provided format</span>
<span class="s2">  string will set the output format</span>
<span class="s2">  Valid keys are &quot;levelname&quot;, &quot;message&quot;, &quot;pathname&quot;, &quot;levelno&quot;, &quot;lineno&quot;,</span>
<span class="s2">  &quot;filename&quot; and &quot;name&quot;.</span>

<span class="s2">  TORCH_LOGS_OUT=/tmp/output.txt will output the logs to /tmp/output.txt as</span>
<span class="s2">  well. This is useful when the output is long.</span>
<span class="s2">&quot;&quot;&quot;</span>  <span class="c1"># flake8: noqa: B950</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">TORCH_LOGS Info</span>
<span class="si">{</span><span class="n">examples</span><span class="si">}</span>

<span class="si">{</span><span class="n">heading</span><span class="si">}</span>
<span class="si">{</span><span class="n">setting_info</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">msg</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_invalid_settings_err_msg</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">valid_settings</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">log_registry</span><span class="o">.</span><span class="n">log_alias_to_log_qnames</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">log_registry</span><span class="o">.</span><span class="n">artifact_names</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Invalid log settings: </span><span class="si">{</span><span class="n">settings</span><span class="si">}</span><span class="s2">, must be a comma separated list of fully</span>
<span class="s2">qualified module names, registered log names or registered artifact names.</span>
<span class="s2">For more info on various settings, try TORCH_LOGS=&quot;help&quot;</span>
<span class="s2">Valid settings:</span>
<span class="si">{</span><span class="n">valid_settings</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">msg</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_parse_log_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">settings</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">settings</span> <span class="o">==</span> <span class="s2">&quot;help&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">help_message</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">settings</span> <span class="o">==</span> <span class="s2">&quot;+help&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">help_message</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_validate_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_invalid_settings_err_msg</span><span class="p">(</span><span class="n">settings</span><span class="p">))</span>

    <span class="n">settings</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
    <span class="n">log_names</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_name_level_pair</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="n">clean_name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">INCR_VERBOSITY_CHAR</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">clean_name</span> <span class="o">=</span> <span class="n">clean_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">DECR_VERBOSITY_CHAR</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">INCR_VERBOSITY_CHAR</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span>
        <span class="k">elif</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">DECR_VERBOSITY_CHAR</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>

        <span class="k">return</span> <span class="n">clean_name</span><span class="p">,</span> <span class="n">level</span>

    <span class="n">log_state</span> <span class="o">=</span> <span class="n">LogState</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">log_names</span><span class="p">:</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">get_name_level_pair</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;torch&quot;</span>

        <span class="k">if</span> <span class="n">log_registry</span><span class="o">.</span><span class="n">is_log</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">log_qnames</span> <span class="o">=</span> <span class="n">log_registry</span><span class="o">.</span><span class="n">log_alias_to_log_qnames</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">log_state</span><span class="o">.</span><span class="n">enable_log</span><span class="p">(</span><span class="n">log_qnames</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">log_registry</span><span class="o">.</span><span class="n">is_artifact</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="n">log_state</span><span class="o">.</span><span class="n">enable_artifact</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">_is_valid_module</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_has_registered_parent</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="n">log_registry</span><span class="o">.</span><span class="n">register_log</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_registry</span><span class="o">.</span><span class="n">register_child_log</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">log_state</span><span class="o">.</span><span class="n">enable_log</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_invalid_settings_err_msg</span><span class="p">(</span><span class="n">settings</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">log_state</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_is_valid_module</span><span class="p">(</span><span class="n">qname</span><span class="p">):</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="n">qname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_update_log_state_from_env</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">log_state</span>
    <span class="n">log_setting</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">LOG_ENV_VAR</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">log_setting</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_state</span> <span class="o">=</span> <span class="n">_parse_log_settings</span><span class="p">(</span><span class="n">log_setting</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_has_registered_parent</span><span class="p">(</span><span class="n">log_qname</span><span class="p">):</span>
    <span class="n">cur_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">log_qname</span><span class="p">)</span>

    <span class="n">registered_log_qnames</span> <span class="o">=</span> <span class="n">log_registry</span><span class="o">.</span><span class="n">get_log_qnames</span><span class="p">()</span>

    <span class="k">while</span> <span class="n">cur_log</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cur_log</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">registered_log_qnames</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">cur_log</span> <span class="o">=</span> <span class="n">cur_log</span><span class="o">.</span><span class="n">parent</span>

    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span><span class="w"> </span><span class="nf">make_module_path_relative</span><span class="p">(</span><span class="n">abs_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an absolute filepath corresponding to a Python module which was</span>
<span class="sd">    loaded via normal import mechanisms using sys.path, convert it into</span>
<span class="sd">    a relative path relative to one of the Python search paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">abs_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">abs_path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rel_path</span> <span class="o">=</span> <span class="n">abs_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">rel_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">abs_path</span><span class="p">)</span>


<span class="c1"># apply custom formats to artifacts when necessary</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TorchLogsFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">trace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_trace</span> <span class="o">=</span> <span class="n">trace</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">artifact_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="s2">&quot;artifact_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">artifact_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">artifact_formatter</span> <span class="o">=</span> <span class="n">log_registry</span><span class="o">.</span><span class="n">artifact_log_formatters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">artifact_name</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">artifact_formatter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">artifact_formatter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

        <span class="n">record</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">getMessage</span><span class="p">()</span>
        <span class="n">record</span><span class="o">.</span><span class="n">asctime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatTime</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s2">&quot;%m</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>

        <span class="c1"># exception handling - copied from logging.Formatter.format</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">message</span>
        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">exc_info</span><span class="p">:</span>
            <span class="c1"># Cache the traceback text to avoid converting it multiple times</span>
            <span class="c1"># (it&#39;s constant anyway)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="o">.</span><span class="n">exc_text</span><span class="p">:</span>
                <span class="n">record</span><span class="o">.</span><span class="n">exc_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatException</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">exc_info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">exc_text</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="n">exc_text</span>
        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">stack_info</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatStack</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">stack_info</span><span class="p">)</span>

        <span class="n">record</span><span class="o">.</span><span class="n">rankprefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_trace</span> <span class="ow">and</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
            <span class="n">record</span><span class="o">.</span><span class="n">rankprefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[rank</span><span class="si">{</span><span class="n">dist</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span><span class="si">}</span><span class="s2">]:&quot;</span>

        <span class="n">record</span><span class="o">.</span><span class="n">traceid</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_trace</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">trace_id</span> <span class="o">:=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_guards</span><span class="o">.</span><span class="n">CompileContext</span><span class="o">.</span><span class="n">current_trace_id</span><span class="p">())</span>
            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">record</span><span class="o">.</span><span class="n">traceid</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; [</span><span class="si">{</span><span class="n">trace_id</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="n">glog_level_to_abbr</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;DEBUG&quot;</span><span class="p">:</span> <span class="s2">&quot;V&quot;</span><span class="p">,</span>  <span class="c1"># V is for VERBOSE in glog</span>
            <span class="s2">&quot;INFO&quot;</span><span class="p">:</span> <span class="s2">&quot;I&quot;</span><span class="p">,</span>
            <span class="s2">&quot;WARNING&quot;</span><span class="p">:</span> <span class="s2">&quot;W&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ERROR&quot;</span><span class="p">:</span> <span class="s2">&quot;E&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CRITICAL&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">shortlevel</span> <span class="o">=</span> <span class="n">glog_level_to_abbr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">levelname</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">levelname</span><span class="p">)</span>

        <span class="n">record</span><span class="o">.</span><span class="n">artifactprefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">artifact_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">record</span><span class="o">.</span><span class="n">artifactprefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; [__</span><span class="si">{</span><span class="n">artifact_name</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="n">filepath</span> <span class="o">=</span> <span class="n">make_module_path_relative</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">pathname</span><span class="p">)</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">record</span><span class="o">.</span><span class="n">rankprefix</span><span class="si">}{</span><span class="n">shortlevel</span><span class="si">}{</span><span class="n">record</span><span class="o">.</span><span class="n">asctime</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">msecs</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">record</span><span class="o">.</span><span class="n">process</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">:&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">record</span><span class="o">.</span><span class="n">lineno</span><span class="si">}</span><span class="s2">]</span><span class="si">{</span><span class="n">record</span><span class="o">.</span><span class="n">traceid</span><span class="si">}{</span><span class="n">record</span><span class="o">.</span><span class="n">artifactprefix</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_trace</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">s</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;failing metadata: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">r</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_default_formatter</span><span class="p">():</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">LOG_FORMAT_ENV_VAR</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TorchLogsFormatter</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;short&quot;</span><span class="p">,</span> <span class="s2">&quot;basic&quot;</span><span class="p">):</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">BASIC_FORMAT</span>
        <span class="k">return</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>


<span class="n">DEFAULT_FORMATTER</span> <span class="o">=</span> <span class="n">_default_formatter</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_setup_handlers</span><span class="p">(</span><span class="n">create_handler_fn</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
    <span class="n">debug_handler</span> <span class="o">=</span> <span class="n">_track_handler</span><span class="p">(</span><span class="n">create_handler_fn</span><span class="p">())</span>
    <span class="n">debug_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">DEFAULT_FORMATTER</span><span class="p">)</span>
    <span class="n">debug_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">debug_handler</span><span class="p">)</span>


<span class="n">handlers</span> <span class="o">=</span> <span class="n">WeakSet</span><span class="p">()</span>  <span class="c1"># type: ignore[var-annotated]</span>


<span class="c1"># mark handlers that we&#39;ve created</span>
<span class="c1"># so we don&#39;t modify user handlers</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_track_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
    <span class="n">handlers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">handler</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_is_torch_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">handlers</span>


<span class="c1"># clears all torch handlers on specified loggers</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_clear_handlers</span><span class="p">(</span><span class="n">log</span><span class="p">):</span>
    <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">handler</span> <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">log</span><span class="o">.</span><span class="n">handlers</span> <span class="k">if</span> <span class="n">_is_torch_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_reset_logs</span><span class="p">():</span>
    <span class="c1"># reset all registered logs</span>
    <span class="k">for</span> <span class="n">log_qname</span> <span class="ow">in</span> <span class="n">log_registry</span><span class="o">.</span><span class="n">get_log_qnames</span><span class="p">():</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">log_qname</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">_clear_handlers</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>

    <span class="c1"># reset all artifact and child logs</span>
    <span class="k">for</span> <span class="n">artifact_log_qname</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
        <span class="n">log_registry</span><span class="o">.</span><span class="n">get_artifact_log_qnames</span><span class="p">(),</span> <span class="n">log_registry</span><span class="o">.</span><span class="n">get_child_log_qnames</span><span class="p">()</span>
    <span class="p">):</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">artifact_log_qname</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">trace_log</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_clear_handlers</span><span class="p">(</span><span class="n">trace_log</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_log_state</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">log_state</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_set_log_state</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">log_state</span>
    <span class="n">log_state</span> <span class="o">=</span> <span class="n">state</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_init_logs</span><span class="p">(</span><span class="n">log_file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">_reset_logs</span><span class="p">()</span>
    <span class="n">_update_log_state_from_env</span><span class="p">()</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">LOG_OUT_ENV_VAR</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_file_name</span> <span class="o">=</span> <span class="n">out</span>

    <span class="c1"># First, reset all known (registered) loggers to NOTSET, so that they</span>
    <span class="c1"># respect their parent log level</span>
    <span class="k">for</span> <span class="n">log_qname</span> <span class="ow">in</span> <span class="n">log_registry</span><span class="o">.</span><span class="n">get_log_qnames</span><span class="p">():</span>
        <span class="c1"># But not the top level torch level: this defaults to WARNING so</span>
        <span class="c1"># that our log messages don&#39;t leak to the lower levels</span>
        <span class="k">if</span> <span class="n">log_qname</span> <span class="o">==</span> <span class="s2">&quot;torch&quot;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">log_qname</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">)</span>

    <span class="c1"># Now, for all loggers which the user requested to have non-standard</span>
    <span class="c1"># logging behavior, modify their log levels</span>
    <span class="k">for</span> <span class="n">log_qname</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">log_state</span><span class="o">.</span><span class="n">get_log_level_pairs</span><span class="p">():</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">log_qname</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

    <span class="c1"># Finally, setup handlers for all registered loggers</span>
    <span class="k">for</span> <span class="n">log_qname</span> <span class="ow">in</span> <span class="n">log_registry</span><span class="o">.</span><span class="n">get_log_qnames</span><span class="p">():</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">log_qname</span><span class="p">)</span>
        <span class="n">_setup_handlers</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">,</span>
            <span class="n">log</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">log_file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_setup_handlers</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_file_name</span><span class="p">),</span>
                <span class="n">log</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># configure artifact loggers, note: this must happen last</span>
    <span class="c1"># since the levels of ancestor loggers are taken into account</span>
    <span class="k">for</span> <span class="n">artifact_log_qname</span> <span class="ow">in</span> <span class="n">log_registry</span><span class="o">.</span><span class="n">get_artifact_log_qnames</span><span class="p">():</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">artifact_log_qname</span><span class="p">)</span>
        <span class="n">configure_artifact_log</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>

    <span class="c1"># Setup handler for the special trace_log, with different default</span>
    <span class="c1"># configuration</span>
    <span class="n">trace_dir_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TRACE_ENV_VAR</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># This handler may remove itself if trace_dir_name is None and we are not</span>
    <span class="c1"># actually in an FB environment.  This allows us to defer actually</span>
    <span class="c1"># initializing it until we actually need to log anything.  This is</span>
    <span class="c1"># important because JK initializes a C++ singleton, which will pork our</span>
    <span class="c1"># process if we subsequently fork.</span>
    <span class="k">global</span> <span class="n">LOG_TRACE_HANDLER</span>
    <span class="k">if</span> <span class="n">LOG_TRACE_HANDLER</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">LOG_TRACE_HANDLER</span> <span class="o">=</span> <span class="n">LazyTraceHandler</span><span class="p">(</span><span class="n">trace_dir_name</span><span class="p">)</span>
    <span class="c1"># This log is ALWAYS at debug level.  We will additionally test if there</span>
    <span class="c1"># are any handlers before deciding to actually call logging on this.  Do</span>
    <span class="c1"># not manually call</span>
    <span class="n">trace_log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">trace_log_handler</span> <span class="o">=</span> <span class="n">_track_handler</span><span class="p">(</span><span class="n">LOG_TRACE_HANDLER</span><span class="p">)</span>
    <span class="n">trace_log_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">TorchLogsFormatter</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">trace_log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">trace_log_handler</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LazyTraceHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Like FileHandler, but the file is allocated lazily only upon the first log message&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="c1"># This is implemented in the same way that delay is implemented on</span>
        <span class="c1"># FileHandler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">=</span> <span class="n">root_dir</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_builtin_open</span> <span class="o">=</span> <span class="nb">open</span>

    <span class="c1"># cloned from FileHandler in cpython</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;close&quot;</span><span class="p">):</span>
                            <span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Issue #19523: call unconditionally to</span>
                <span class="c1"># prevent a handler leak when delay is set</span>
                <span class="c1"># Also see Issue #42378: we also rely on</span>
                <span class="c1"># self._closed being set to True there</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">TRACE_LOG_DIR</span> <span class="o">=</span> <span class="s2">&quot;/logs&quot;</span>

                <span class="kn">import</span><span class="w"> </span><span class="nn">torch.version</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">torch_version</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">hasattr</span><span class="p">(</span><span class="n">torch_version</span><span class="p">,</span> <span class="s2">&quot;git_version&quot;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;MAST_HPC_JOB_NAME&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;LazyTraceHandler: disabled because not fbcode or conda on mast&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">_utils_internal</span><span class="o">.</span><span class="n">justknobs_check</span><span class="p">(</span><span class="s2">&quot;pytorch/trace:enable&quot;</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;LazyTraceHandler: disabled because justknobs_check(&#39;pytorch/trace:enable&#39;) returned False&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">TRACE_LOG_DIR</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;LazyTraceHandler: disabled because </span><span class="si">%s</span><span class="s2"> does not exist&quot;</span><span class="p">,</span>
                        <span class="n">TRACE_LOG_DIR</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">TRACE_LOG_DIR</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;LazyTraceHandler: disabled because </span><span class="si">%s</span><span class="s2"> is not writeable&quot;</span><span class="p">,</span>
                        <span class="n">TRACE_LOG_DIR</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">=</span> <span class="n">TRACE_LOG_DIR</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">ranksuffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
                    <span class="n">ranksuffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;rank_</span><span class="si">{</span><span class="n">dist</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span><span class="si">}</span><span class="s2">_&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w+&quot;</span><span class="p">,</span>
                    <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.log&quot;</span><span class="p">,</span>
                    <span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;dedicated_log_torch_trace_</span><span class="si">{</span><span class="n">ranksuffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="nb">dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span>
                    <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;LazyTraceHandler: logging to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We go poof, remove and no-op</span>
                <span class="n">trace_log</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">warning_once</span><span class="p">(</span><span class="n">logger_obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is similar to `logger.warning()`, but will emit the warning with the same message only once</span>
<span class="sd">    Note: The cache is for the function arguments, so 2 different callers using the same arguments will hit the cache.</span>
<span class="sd">    The assumption here is that all warning messages are unique across the code. If they aren&#39;t then need to switch to</span>
<span class="sd">    another type of cache that includes the caller frame information in the hashing function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger_obj</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LazyString</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>


<span class="c1"># Logs the time it takes to do structured logging by frame/compile id</span>
<span class="c1"># key is always {frame_id}_{frame_compile_id}</span>
<span class="n">structured_logging_overhead</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">add_structured_logging_overhead</span><span class="p">(</span><span class="n">time_spent</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">structured_logging_overhead</span>
    <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">trace_id</span> <span class="o">:=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_guards</span><span class="o">.</span><span class="n">CompileContext</span><span class="o">.</span><span class="n">current_trace_id</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">frame_id</span> <span class="o">=</span> <span class="n">trace_id</span><span class="o">.</span><span class="n">compile_id</span><span class="o">.</span><span class="n">frame_id</span>
        <span class="n">frame_compile_id</span> <span class="o">=</span> <span class="n">trace_id</span><span class="o">.</span><span class="n">compile_id</span><span class="o">.</span><span class="n">frame_compile_id</span>
        <span class="c1"># Why not trace_id.attempt, like structured logging?</span>
        <span class="c1"># We aggregate across all attempts because</span>
        <span class="c1"># a compilation metric is logged per successful attempt</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">frame_compile_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="c1"># TODO: deal with structured logging that occurs outside of specific compile ids</span>
    <span class="c1"># It&#39;s hard to figure out where we would log that if we want it in compilation metrics</span>
    <span class="c1"># itself.</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">structured_logging_overhead</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">time_spent</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_structured_logging_overhead</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
    <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">trace_id</span> <span class="o">:=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_guards</span><span class="o">.</span><span class="n">CompileContext</span><span class="o">.</span><span class="n">current_trace_id</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">frame_id</span> <span class="o">=</span> <span class="n">trace_id</span><span class="o">.</span><span class="n">compile_id</span><span class="o">.</span><span class="n">frame_id</span>
        <span class="n">frame_compile_id</span> <span class="o">=</span> <span class="n">trace_id</span><span class="o">.</span><span class="n">compile_id</span><span class="o">.</span><span class="n">frame_compile_id</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">frame_compile_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">structured_logging_overhead</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">trace_structured_artifact</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># this will go in metadata</span>
    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">payload_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]]]</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">trace_structured</span><span class="p">(</span>
        <span class="s2">&quot;artifact&quot;</span><span class="p">,</span>
        <span class="n">metadata_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;encoding&quot;</span><span class="p">:</span> <span class="n">encoding</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">payload_fn</span><span class="o">=</span><span class="n">payload_fn</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">trace_structured</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="c1"># NB: metadata expected to be dict so adding more info is forward compatible</span>
    <span class="c1"># Tuple[str, int] is a special case for string interning</span>
    <span class="n">metadata_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">payload_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]]]</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">suppress_context</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">expect_trace_id</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Whether or not we expect to have a current trace id</span>
    <span class="n">record_logging_overhead</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Whether or not to record the time spent on structured logging</span>
    <span class="n">compile_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CompileId</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Optional if unavailable in the trace</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    metadata is an arbitrary JSON compatible struct, but it&#39;s expected to not be</span>
<span class="sd">    too long (e.g., less than 1MB)</span>

<span class="sd">    payload is an arbitrary string, which can be arbitrarily long (but expected to have</span>
<span class="sd">    newlines so no lines are too long)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">&quot;rank&quot;</span><span class="p">,</span>
        <span class="s2">&quot;compiled_autograd_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;frame_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;frame_compile_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;attempt&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span>
        <span class="n">metadata_fn</span>
    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;metadata_fn should be callable, but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">metadata_fn</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span>
        <span class="n">payload_fn</span>
    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;payload_fn should be callable, but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">payload_fn</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="c1"># trace_log never propagates and is ALWAYS DEBUG, so also check that there</span>
    <span class="c1"># are handlers instead of checking the log level</span>
    <span class="k">if</span> <span class="n">trace_log</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time_ns</span><span class="p">()</span>
        <span class="n">record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">record</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_fn</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_context</span><span class="p">:</span>
            <span class="c1"># TODO: Actually, the rank probably should just be emitted once at</span>
            <span class="c1"># the top, and not repeatedly spammed in all the logs, since it</span>
            <span class="c1"># never changes and we assume no interleaving</span>
            <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dist</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
                <span class="n">record</span><span class="p">[</span><span class="s2">&quot;rank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span>

            <span class="n">trace_id</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_guards</span><span class="o">.</span><span class="n">CompileContext</span><span class="o">.</span><span class="n">current_trace_id</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">expect_trace_id</span> <span class="ow">and</span> <span class="n">trace_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">compile_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Record the stack of the log call to better diagnose why we</span>
                <span class="c1"># don&#39;t have a frame id for it</span>
                <span class="n">record</span><span class="p">[</span><span class="s2">&quot;stack&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_logging</span><span class="o">.</span><span class="n">structured</span><span class="o">.</span><span class="n">from_traceback</span><span class="p">(</span>
                    <span class="n">CapturedTraceback</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cid</span> <span class="o">=</span> <span class="n">trace_id</span><span class="o">.</span><span class="n">compile_id</span> <span class="k">if</span> <span class="n">trace_id</span> <span class="k">else</span> <span class="n">compile_id</span>
                <span class="k">if</span> <span class="n">cid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cid</span><span class="o">.</span><span class="n">compiled_autograd_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">record</span><span class="p">[</span><span class="s2">&quot;compiled_autograd_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cid</span><span class="o">.</span><span class="n">compiled_autograd_id</span>
                    <span class="k">if</span> <span class="n">cid</span><span class="o">.</span><span class="n">frame_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">record</span><span class="p">[</span><span class="s2">&quot;frame_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cid</span><span class="o">.</span><span class="n">frame_id</span>
                    <span class="k">if</span> <span class="n">cid</span><span class="o">.</span><span class="n">frame_compile_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">record</span><span class="p">[</span><span class="s2">&quot;frame_compile_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cid</span><span class="o">.</span><span class="n">frame_compile_id</span>
                <span class="k">if</span> <span class="n">trace_id</span><span class="p">:</span>
                    <span class="n">record</span><span class="p">[</span><span class="s2">&quot;attempt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trace_id</span><span class="o">.</span><span class="n">attempt</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="n">payload_fn</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="c1"># special case to look better</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">]&quot;</span>
                <span class="k">else</span><span class="p">:</span>

                    <span class="k">def</span><span class="w"> </span><span class="nf">json_default</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                        <span class="c1"># Sets aren&#39;t json serializable</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
                            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Object of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="si">}</span><span class="s2"> is not JSON serializable&quot;</span>
                        <span class="p">)</span>

                    <span class="c1"># force newlines so we are unlikely to overflow line limit</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">json_default</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
            <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
            <span class="n">record</span><span class="p">[</span><span class="s2">&quot;has_payload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="n">trace_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">record</span><span class="p">,</span> <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">},</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">log_trace_structured_event</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">record_logging_overhead</span><span class="p">:</span>
            <span class="c1"># Convert to seconds from nanoseconds, add it to the frame compile total</span>
            <span class="n">structured_logging_overhead_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time_ns</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span>
            <span class="n">add_structured_logging_overhead</span><span class="p">(</span><span class="n">structured_logging_overhead_s</span><span class="p">)</span>


<span class="n">GET_DTRACE_STRUCTURED</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">def</span><span class="w"> </span><span class="nf">dtrace_structured</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="c1"># NB: metadata expected to be dict so adding more info is forward compatible</span>
    <span class="c1"># Tuple[str, int] is a special case for string interning</span>
    <span class="n">metadata_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">payload_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]]]</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">suppress_context</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">expect_trace_id</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Whether or not we expect to have a current trace id</span>
    <span class="n">record_logging_overhead</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Whether or not to record the time spent on structured logging</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For logging more detailed information used for debugging. This may result in</span>
<span class="sd">    the program becoming slow.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">GET_DTRACE_STRUCTURED</span><span class="p">:</span>
        <span class="n">trace_structured</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">metadata_fn</span><span class="p">,</span>
            <span class="n">payload_fn</span><span class="o">=</span><span class="n">payload_fn</span><span class="p">,</span>
            <span class="n">suppress_context</span><span class="o">=</span><span class="n">suppress_context</span><span class="p">,</span>
            <span class="n">expect_trace_id</span><span class="o">=</span><span class="n">expect_trace_id</span><span class="p">,</span>
            <span class="n">record_logging_overhead</span><span class="o">=</span><span class="n">record_logging_overhead</span><span class="p">,</span>
        <span class="p">)</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">torch._guards</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch._utils_internal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.distributed</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dist</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>



  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright PyTorch Contributors.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.0.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>