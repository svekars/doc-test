
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>torch.package.package_importer &#8212; PyTorch main documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=949a1ff5" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/katex-math.css?v=91adb8b6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/jit.css?v=8de1ea5d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=3ccf5357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom2.css?v=baa440dc" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../_static/documentation_options.js?v=a8da1a53"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=940804e7"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/torch/package/package_importer';</script>
    <script src="../../../_static/js/star-rating.js?v=8861fcb6"></script>
    <script src="../../../_static/js/send-feedback.js?v=5646bf45"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="main (2.6.0 )" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script type="text/javascript" src="../../../_static/js/send-feedback.js"></script>
<script type="text/javascript" src="../../../_static/js/star-rating.js"></script>
<script type="text/javascript" src="../../../_static/js/cookie-banner.js"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-TEST12345"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-TEST12345');
    </script>

  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
<body data-feedback-url="https://github.com/pytorch/pytorch">
  <div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>

          <li class="main-menu-item">
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Learn
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class=dropdown-title>Get Started</span>
                  <p>Run PyTorch locally or get started quickly with one of the supported cloud platforms</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Tutorials</span>
                  <p>Whats new in PyTorch tutorials</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Learn the Basics</span>
                  <p>Familiarize yourself with PyTorch concepts and modules</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch Recipes</span>
                  <p>Bite-size, ready-to-deploy PyTorch code examples</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Intro to PyTorch - YouTube Series</span>
                  <p>Master PyTorch basics with our engaging YouTube tutorial series</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Ecosystem
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Tools</span>
                  <p>Learn about the tools and frameworks in the PyTorch Ecosystem</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class=dropdown-title>Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="" target="_blank">
                  <span class=dropdown-title>Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class=dropdown-title>Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Contributor Awards - 2024</span>
                  <p>Award winners announced at this year's PyTorch Conference</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Edge
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">About PyTorch Edge</span>
                  <p>Build innovative and privacy-aware AI experiences for edge devices</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">ExecuTorch</span>
                  <p>End-to-end solution for enabling on-device inference capabilities across mobile and edge devices</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">ExecuTorch Docs</span>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch</span>
                  <p>Explore the documentation for comprehensive guidance on how to use PyTorch</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch Domains</span>
                  <p>Read the PyTorch Domains documentation to learn more about domain-specific libraries</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Blogs & News
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch Blog</span>
                  <p>Catch up on the latest technical news and happenings</p>
                </a>
                 <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Community Blog</span>
                  <p>Stories from the PyTorch ecosystem</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Videos</span>
                  <p>Learn about the latest PyTorch tutorials, new, and more </p>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Newsletter</span>
                  <p>Stay up-to-date with the latest updates</p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                About
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn more about the PyTorch Foundation</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Governing Board</span>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Cloud Credit Program</span>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Technical Advisory Council</span>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Staff</span>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Contact Us</span>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
            <div class="no-dropdown">
              <a href="" data-cta="join">
                Become a Member
              </a>
            </div>
          </li>
          <li>
           <div class="main-menu-item">
             <a href="" class="github-icon">
             </a>
           </div>
          </li>
          <!--- TODO: This block adds the search icon to the nav bar. We will enable it later.
          <li>
            <div class="main-menu-item">
             <a href="" class="search-icon">
             </a>
            </div>
          </li>
          --->
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Home</p>
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../python-api/index.html">
    Python API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../notes/index.html">
    Developer Notes
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://pytorch.org/tutorials/">
    Tutorials
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://x.com/PyTorch" title="X" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-x-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">X</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/pytorch/pytorch" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/torch" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-custom fa-pypi fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../python-api/index.html">
    Python API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../notes/index.html">
    Developer Notes
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://pytorch.org/tutorials/">
    Tutorials
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://x.com/PyTorch" title="X" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-x-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">X</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/pytorch/pytorch" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/torch" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-custom fa-pypi fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../../torch.html" class="nav-link">torch</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">torch.package.package_importer</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">
<div class="rating">
    Rate this Page
    <div class="stars">
        
        <span class="star" data-value="1">★</span>
        
        <span class="star" data-value="2">★</span>
        
        <span class="star" data-value="3">★</span>
        
        <span class="star" data-value="4">★</span>
        
        <span class="star" data-value="5">★</span>
        
    </div>
</div>
</div>
      
    </div>
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for torch.package.package_importer</h1><div class="highlight"><pre>
<span></span><span class="c1"># mypy: allow-untyped-defs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">builtins</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib.machinery</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">linecache</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">types</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">BinaryIO</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">weakref</span><span class="w"> </span><span class="kn">import</span> <span class="n">WeakValueDictionary</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.serialization</span><span class="w"> </span><span class="kn">import</span> <span class="n">_get_restore_location</span><span class="p">,</span> <span class="n">_maybe_decode_ascii</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">._directory_reader</span><span class="w"> </span><span class="kn">import</span> <span class="n">DirectoryReader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">._importlib</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">_calc___package__</span><span class="p">,</span>
    <span class="n">_normalize_line_endings</span><span class="p">,</span>
    <span class="n">_normalize_path</span><span class="p">,</span>
    <span class="n">_resolve_name</span><span class="p">,</span>
    <span class="n">_sanity_check</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">._mangling</span><span class="w"> </span><span class="kn">import</span> <span class="n">demangle</span><span class="p">,</span> <span class="n">PackageMangler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">._package_unpickler</span><span class="w"> </span><span class="kn">import</span> <span class="n">PackageUnpickler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.file_structure_representation</span><span class="w"> </span><span class="kn">import</span> <span class="n">_create_directory_from_file_list</span><span class="p">,</span> <span class="n">Directory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.importer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Importer</span>


<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.glob_group</span><span class="w"> </span><span class="kn">import</span> <span class="n">GlobPattern</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PackageImporter&quot;</span><span class="p">]</span>


<span class="c1"># This is a list of imports that are implicitly allowed even if they haven&#39;t</span>
<span class="c1"># been marked as extern. This is to work around the fact that Torch implicitly</span>
<span class="c1"># depends on numpy and package can&#39;t track it.</span>
<span class="c1"># https://github.com/pytorch/MultiPy/issues/46</span>
<span class="n">IMPLICIT_IMPORT_ALLOWLIST</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;numpy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;numpy.core&quot;</span><span class="p">,</span>
    <span class="s2">&quot;numpy.core._multiarray_umath&quot;</span><span class="p">,</span>
    <span class="c1"># FX GraphModule might depend on builtins module and users usually</span>
    <span class="c1"># don&#39;t extern builtins. Here we import it here by default.</span>
    <span class="s2">&quot;builtins&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="c1"># Compatibility name mapping to facilitate upgrade of external modules.</span>
<span class="c1"># The primary motivation is to enable Numpy upgrade that many modules</span>
<span class="c1"># depend on. The latest release of Numpy removed `numpy.str` and</span>
<span class="c1"># `numpy.bool` breaking unpickling for many modules.</span>
<span class="n">EXTERN_IMPORT_COMPAT_NAME_MAPPING</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;numpy&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;str&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>


<div class="viewcode-block" id="PackageImporter">
<a class="viewcode-back" href="../../../python-api/package.html#torch.package.PackageImporter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PackageImporter</span><span class="p">(</span><span class="n">Importer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Importers allow you to load code written to packages by :class:`PackageExporter`.</span>
<span class="sd">    Code is loaded in a hermetic way, using files from the package</span>
<span class="sd">    rather than the normal python import system. This allows</span>
<span class="sd">    for the packaging of PyTorch model code and data so that it can be run</span>
<span class="sd">    on a server or used in the future for transfer learning.</span>

<span class="sd">    The importer for packages ensures that code in the module can only be loaded from</span>
<span class="sd">    within the package, except for modules explicitly listed as external during export.</span>
<span class="sd">    The file ``extern_modules`` in the zip archive lists all the modules that a package externally depends on.</span>
<span class="sd">    This prevents &quot;implicit&quot; dependencies where the package runs locally because it is importing</span>
<span class="sd">    a locally-installed package, but then fails when the package is copied to another machine.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;The dictionary of already loaded modules from this package, equivalent to ``sys.modules`` but</span>
<span class="sd">    local to this importer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">modules</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">]</span>

<div class="viewcode-block" id="PackageImporter.__init__">
<a class="viewcode-back" href="../../../python-api/package.html#torch.package.PackageImporter.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">file_or_buffer</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">PyTorchFileReader</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span> <span class="n">BinaryIO</span><span class="p">],</span>
        <span class="n">module_allowed</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">module_name</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open ``file_or_buffer`` for importing. This checks that the imported package only requires modules</span>
<span class="sd">        allowed by ``module_allowed``</span>

<span class="sd">        Args:</span>
<span class="sd">            file_or_buffer: a file-like object (has to implement :meth:`read`, :meth:`readline`, :meth:`tell`, and :meth:`seek`),</span>
<span class="sd">                a string, or an ``os.PathLike`` object containing a filename.</span>
<span class="sd">            module_allowed (Callable[[str], bool], optional): A method to determine if a externally provided module</span>
<span class="sd">                should be allowed. Can be used to ensure packages loaded do not depend on modules that the server</span>
<span class="sd">                does not support. Defaults to allowing anything.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ImportError: If the package will use a disallowed module.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_log_api_usage_once</span><span class="p">(</span><span class="s2">&quot;torch.package.PackageImporter&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zip_reader</span><span class="p">:</span> <span class="n">Any</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_or_buffer</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">PyTorchFileReader</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;&lt;pytorch_file_reader&gt;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zip_reader</span> <span class="o">=</span> <span class="n">file_or_buffer</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_or_buffer</span><span class="p">,</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fspath</span><span class="p">(</span><span class="n">file_or_buffer</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">zip_reader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">PyTorchFileReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">zip_reader</span> <span class="o">=</span> <span class="n">DirectoryReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;&lt;binary&gt;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zip_reader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">PyTorchFileReader</span><span class="p">(</span><span class="n">file_or_buffer</span><span class="p">)</span>

        <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_log_api_usage_metadata</span><span class="p">(</span>
            <span class="s2">&quot;torch.package.PackageImporter.metadata&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;serialization_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_reader</span><span class="o">.</span><span class="n">serialization_id</span><span class="p">(),</span>
                <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">_PackageNode</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extern_modules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_extern</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">extern_module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extern_modules</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">module_allowed</span><span class="p">(</span><span class="n">extern_module</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;package &#39;</span><span class="si">{</span><span class="n">file_or_buffer</span><span class="si">}</span><span class="s2">&#39; needs the external module &#39;</span><span class="si">{</span><span class="n">extern_module</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;but that module has been disallowed&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_extern</span><span class="p">(</span><span class="n">extern_module</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_reader</span><span class="o">.</span><span class="n">get_all_records</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_file</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">patched_builtins</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patched_builtins</span><span class="p">[</span><span class="s2">&quot;__import__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__import__</span>
        <span class="c1"># Allow packaged modules to reference their PackageImporter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;torch_package_importer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>  <span class="c1"># type: ignore[assignment]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mangler</span> <span class="o">=</span> <span class="n">PackageMangler</span><span class="p">()</span>

        <span class="c1"># used for reduce deserializaiton</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_context</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_map_location</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># used for torch.serialization._load</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Unpickler</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">PackageUnpickler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="PackageImporter.import_module">
<a class="viewcode-back" href="../../../python-api/package.html#torch.package.PackageImporter.import_module">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">import_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a module from the package if it hasn&#39;t already been loaded, and then return</span>
<span class="sd">        the module. Modules are loaded locally</span>
<span class="sd">        to the importer and will appear in ``self.modules`` rather than ``sys.modules``.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): Fully qualified name of the module to load.</span>
<span class="sd">            package ([type], optional): Unused, but present to match the signature of importlib.import_module. Defaults to ``None``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            types.ModuleType: The (possibly already) loaded module.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We should always be able to support importing modules from this package.</span>
        <span class="c1"># This is to support something like:</span>
        <span class="c1">#   obj = importer.load_pickle(...)</span>
        <span class="c1">#   importer.import_module(obj.__module__)  &lt;- this string will be mangled</span>
        <span class="c1">#</span>
        <span class="c1"># Note that _mangler.demangle will not demangle any module names</span>
        <span class="c1"># produced by a different PackageImporter instance.</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mangler</span><span class="o">.</span><span class="n">demangle</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gcd_import</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="PackageImporter.load_binary">
<a class="viewcode-back" href="../../../python-api/package.html#torch.package.PackageImporter.load_binary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resource</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load raw bytes.</span>

<span class="sd">        Args:</span>
<span class="sd">            package (str): The name of module package (e.g. ``&quot;my_package.my_subpackage&quot;``).</span>
<span class="sd">            resource (str): The unique name for the resource.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bytes: The loaded data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile_path</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_reader</span><span class="o">.</span><span class="n">get_record</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="PackageImporter.load_text">
<a class="viewcode-back" href="../../../python-api/package.html#torch.package.PackageImporter.load_text">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_text</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">package</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">resource</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
        <span class="n">errors</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;strict&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a string.</span>

<span class="sd">        Args:</span>
<span class="sd">            package (str): The name of module package (e.g. ``&quot;my_package.my_subpackage&quot;``).</span>
<span class="sd">            resource (str): The unique name for the resource.</span>
<span class="sd">            encoding (str, optional): Passed to ``decode``. Defaults to ``&#39;utf-8&#39;``.</span>
<span class="sd">            errors (str, optional): Passed to ``decode``. Defaults to ``&#39;strict&#39;``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The loaded text.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_binary</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span></div>


<div class="viewcode-block" id="PackageImporter.load_pickle">
<a class="viewcode-back" href="../../../python-api/package.html#torch.package.PackageImporter.load_pickle">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resource</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Unpickles the resource from the package, loading any modules that are needed to construct the objects</span>
<span class="sd">        using :meth:`import_module`.</span>

<span class="sd">        Args:</span>
<span class="sd">            package (str): The name of module package (e.g. ``&quot;my_package.my_subpackage&quot;``).</span>
<span class="sd">            resource (str): The unique name for the resource.</span>
<span class="sd">            map_location: Passed to `torch.load` to determine how tensors are mapped to devices. Defaults to ``None``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The unpickled object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pickle_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zipfile_path</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span>
        <span class="n">restore_location</span> <span class="o">=</span> <span class="n">_get_restore_location</span><span class="p">(</span><span class="n">map_location</span><span class="p">)</span>
        <span class="n">loaded_storages</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">loaded_reduces</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">storage_context</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">DeserializationStorageContext</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">load_tensor</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">restore_location</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.storage&quot;</span>

            <span class="k">if</span> <span class="n">storage_context</span><span class="o">.</span><span class="n">has_storage</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="n">storage</span> <span class="o">=</span> <span class="n">storage_context</span><span class="o">.</span><span class="n">get_storage</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">_typed_storage</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_reader</span><span class="o">.</span><span class="n">get_storage_from_record</span><span class="p">(</span>
                    <span class="s2">&quot;.data/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dtype</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zip_reader</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">PyTorchFileReader</span><span class="p">):</span>
                    <span class="n">storage_context</span><span class="o">.</span><span class="n">add_storage</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tensor</span><span class="p">)</span>
                <span class="n">storage</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">_typed_storage</span><span class="p">()</span>
            <span class="n">loaded_storages</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">restore_location</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">persistent_load</span><span class="p">(</span><span class="n">saved_id</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">saved_id</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
            <span class="n">typename</span> <span class="o">=</span> <span class="n">_maybe_decode_ascii</span><span class="p">(</span><span class="n">saved_id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">saved_id</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="k">if</span> <span class="n">typename</span> <span class="o">==</span> <span class="s2">&quot;storage&quot;</span><span class="p">:</span>
                <span class="n">storage_type</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">storage_type</span><span class="o">.</span><span class="n">dtype</span>

                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loaded_storages</span><span class="p">:</span>
                    <span class="n">load_tensor</span><span class="p">(</span>
                        <span class="n">dtype</span><span class="p">,</span>
                        <span class="n">size</span><span class="p">,</span>
                        <span class="n">key</span><span class="p">,</span>
                        <span class="n">_maybe_decode_ascii</span><span class="p">(</span><span class="n">location</span><span class="p">),</span>
                        <span class="n">restore_location</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">storage</span> <span class="o">=</span> <span class="n">loaded_storages</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="c1"># TODO: Once we decide to break serialization FC, we can</span>
                <span class="c1"># stop wrapping with TypedStorage</span>
                <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">TypedStorage</span><span class="p">(</span>
                    <span class="n">wrap_storage</span><span class="o">=</span><span class="n">storage</span><span class="o">.</span><span class="n">_untyped_storage</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">_internal</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">typename</span> <span class="o">==</span> <span class="s2">&quot;reduce_package&quot;</span><span class="p">:</span>
                <span class="c1"># to fix BC breaking change, objects on this load path</span>
                <span class="c1"># will be loaded multiple times erroneously</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">data</span>
                    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
                <span class="n">reduce_id</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">data</span>
                <span class="k">if</span> <span class="n">reduce_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loaded_reduces</span><span class="p">:</span>
                    <span class="n">loaded_reduces</span><span class="p">[</span><span class="n">reduce_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">loaded_reduces</span><span class="p">[</span><span class="n">reduce_id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown typename for persistent_load, expected &#39;storage&#39; or &#39;reduce_package&#39; but got &#39;</span><span class="si">{</span><span class="n">typename</span><span class="si">}</span><span class="s2">&#39;&quot;</span>

        <span class="c1"># Load the data (which may in turn use `persistent_load` to load tensors)</span>
        <span class="n">data_file</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zip_reader</span><span class="o">.</span><span class="n">get_record</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">))</span>
        <span class="n">unpickler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Unpickler</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
        <span class="n">unpickler</span><span class="o">.</span><span class="n">persistent_load</span> <span class="o">=</span> <span class="n">persistent_load</span>  <span class="c1"># type: ignore[assignment]</span>

        <span class="nd">@contextmanager</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">set_deserialization_context</span><span class="p">():</span>
            <span class="c1"># to let reduce_package access deserializaiton context</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_context</span> <span class="o">=</span> <span class="n">storage_context</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_map_location</span> <span class="o">=</span> <span class="n">map_location</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">storage_context</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_map_location</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">with</span> <span class="n">set_deserialization_context</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">unpickler</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="c1"># TODO from zdevito:</span>
        <span class="c1">#   This stateful weird function will need to be removed in our efforts</span>
        <span class="c1">#   to unify the format. It has a race condition if multiple python</span>
        <span class="c1">#   threads try to read independent files</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">_utils</span><span class="o">.</span><span class="n">_validate_loaded_sparse_tensors</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="PackageImporter.id">
<a class="viewcode-back" href="../../../python-api/package.html#torch.package.PackageImporter.id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns internal identifier that torch.package uses to distinguish :class:`PackageImporter` instances.</span>
<span class="sd">        Looks like::</span>

<span class="sd">            &lt;torch_package_0&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mangler</span><span class="o">.</span><span class="n">parent_name</span><span class="p">()</span></div>


<div class="viewcode-block" id="PackageImporter.file_structure">
<a class="viewcode-back" href="../../../python-api/package.html#torch.package.PackageImporter.file_structure">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">file_structure</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include</span><span class="p">:</span> <span class="s2">&quot;GlobPattern&quot;</span> <span class="o">=</span> <span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="n">exclude</span><span class="p">:</span> <span class="s2">&quot;GlobPattern&quot;</span> <span class="o">=</span> <span class="p">()</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Directory</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a file structure representation of package&#39;s zipfile.</span>

<span class="sd">        Args:</span>
<span class="sd">            include (Union[List[str], str]): An optional string e.g. ``&quot;my_package.my_subpackage&quot;``, or optional list of strings</span>
<span class="sd">                for the names of the files to be included in the zipfile representation. This can also be</span>
<span class="sd">                a glob-style pattern, as described in :meth:`PackageExporter.mock`</span>

<span class="sd">            exclude (Union[List[str], str]): An optional pattern that excludes files whose name match the pattern.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`Directory`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_create_directory_from_file_list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_reader</span><span class="o">.</span><span class="n">get_all_records</span><span class="p">(),</span> <span class="n">include</span><span class="p">,</span> <span class="n">exclude</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PackageImporter.python_version">
<a class="viewcode-back" href="../../../python-api/package.html#torch.package.PackageImporter.python_version">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">python_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the version of python that was used to create this package.</span>

<span class="sd">        Note: this function is experimental and not Forward Compatible. The plan is to move this into a lock</span>
<span class="sd">        file later on.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`Optional[str]` a python version e.g. 3.8.9 or None if no version was stored with this package</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">python_version_path</span> <span class="o">=</span> <span class="s2">&quot;.data/python_version&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zip_reader</span><span class="o">.</span><span class="n">get_record</span><span class="p">(</span><span class="n">python_version_path</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_reader</span><span class="o">.</span><span class="n">has_record</span><span class="p">(</span><span class="n">python_version_path</span><span class="p">)</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_read_extern</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zip_reader</span><span class="o">.</span><span class="n">get_record</span><span class="p">(</span><span class="s2">&quot;.data/extern_modules&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_module</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">is_package</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
        <span class="n">mangled_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mangler</span><span class="o">.</span><span class="n">mangle</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">if</span> <span class="n">filename</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">machinery</span><span class="o">.</span><span class="n">ModuleSpec</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>  <span class="c1"># type: ignore[arg-type]</span>
            <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;&lt;package_importer&gt;&quot;</span><span class="p">,</span>
            <span class="n">is_package</span><span class="o">=</span><span class="n">is_package</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">module_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>
        <span class="n">module</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mangler</span><span class="o">.</span><span class="n">mangle</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="n">ns</span><span class="p">[</span><span class="s2">&quot;__spec__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="n">ns</span><span class="p">[</span><span class="s2">&quot;__loader__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">ns</span><span class="p">[</span><span class="s2">&quot;__file__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mangled_filename</span>
        <span class="n">ns</span><span class="p">[</span><span class="s2">&quot;__cached__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ns</span><span class="p">[</span><span class="s2">&quot;__builtins__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patched_builtins</span>
        <span class="n">ns</span><span class="p">[</span><span class="s2">&quot;__torch_package__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Add this module to our private global registry. It should be unique due to mangling.</span>
        <span class="k">assert</span> <span class="n">module</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_package_imported_modules</span>
        <span class="n">_package_imported_modules</span><span class="p">[</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>

        <span class="c1"># pre-emptively install on the parent to prevent IMPORT_FROM from trying to</span>
        <span class="c1"># access sys.modules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_install_on_parent</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">mangled_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="c1"># pre-emptively install the source in `linecache` so that stack traces,</span>
            <span class="c1"># `inspect`, etc. work.</span>
            <span class="k">assert</span> <span class="n">filename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">linecache</span><span class="o">.</span><span class="n">cache</span>  <span class="c1"># type: ignore[attr-defined]</span>
            <span class="n">linecache</span><span class="o">.</span><span class="n">lazycache</span><span class="p">(</span><span class="n">mangled_filename</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>

            <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_source</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mangled_filename</span><span class="p">)</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">module</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">cur</span><span class="p">:</span> <span class="n">_PathNode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">_PackageNode</span><span class="p">)</span> <span class="ow">or</span> <span class="n">atom</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">IMPLICIT_IMPORT_ALLOWLIST</span><span class="p">:</span>
                    <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">module</span>
                <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;No module named &quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; in self-contained archive &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                    <span class="sa">f</span><span class="s2">&quot; and the module is also not in the list of allowed external modules: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">extern_modules</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">_ExternNode</span><span class="p">):</span>
                <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">compat_mapping</span> <span class="o">:=</span> <span class="n">EXTERN_IMPORT_COMPAT_NAME_MAPPING</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">old_name</span><span class="p">,</span> <span class="n">new_name</span> <span class="ow">in</span> <span class="n">compat_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">old_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">module</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cur</span><span class="o">.</span><span class="n">source_file</span><span class="p">,</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">_PackageNode</span><span class="p">),</span> <span class="n">parent</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compile_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mangled_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_reader</span><span class="o">.</span><span class="n">get_record</span><span class="p">(</span><span class="n">fullpath</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">_normalize_line_endings</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">compile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">mangled_filename</span><span class="p">,</span> <span class="s2">&quot;exec&quot;</span><span class="p">,</span> <span class="n">dont_inherit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># note: named `get_source` so that linecache can find the source</span>
    <span class="c1"># when this is the __loader__ of a module.</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># linecache calls `get_source` with the `module.__name__` as the argument, so we must demangle it here.</span>
        <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">demangle</span><span class="p">(</span><span class="n">module_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_reader</span><span class="o">.</span><span class="n">get_record</span><span class="p">(</span><span class="n">demangle</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__file__</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

    <span class="c1"># note: named `get_resource_reader` so that importlib.resources can find it.</span>
    <span class="c1"># This is otherwise considered an internal method.</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_resource_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">package</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_package</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">package</span><span class="o">.</span><span class="n">__loader__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">_PackageResourceReader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_install_on_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Set the module as an attribute on its parent.</span>
        <span class="n">parent_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">parent_module</span><span class="o">.</span><span class="n">__loader__</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">parent_module</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">module</span><span class="p">)</span>

    <span class="c1"># note: copied from cpython&#39;s import code, with call to create module replaced with _make_module</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_do_find_and_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">module_name_no_parent</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gcd_import</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
            <span class="c1"># Crazy side-effects!</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">parent_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">parent_module</span><span class="o">.</span><span class="n">__path__</span>  <span class="c1"># type: ignore[attr-defined]</span>

            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c1"># when we attempt to import a package only containing pybinded files,</span>
                <span class="c1"># the parent directory isn&#39;t always a package as defined by python,</span>
                <span class="c1"># so we search if the package is actually there or not before calling the error.</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">parent_module</span><span class="o">.</span><span class="n">__loader__</span><span class="p">,</span>
                    <span class="n">importlib</span><span class="o">.</span><span class="n">machinery</span><span class="o">.</span><span class="n">ExtensionFileLoader</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extern_modules</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">_ERR_MSG</span>
                            <span class="o">+</span> <span class="s2">&quot;; </span><span class="si">{!r}</span><span class="s2"> is a c extension module which was not externed. C extension modules </span><span class="se">\</span>
<span class="s2">                            need to be externed by the PackageExporter in order to be used as we do not support interning them.}.&quot;</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                        <span class="n">parent_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">module_name_no_parent</span><span class="p">),</span>
                        <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">,</span>
                    <span class="p">):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">_ERR_MSG</span>
                            <span class="o">+</span> <span class="s2">&quot;; </span><span class="si">{!r}</span><span class="s2"> is a c extension package which does not contain </span><span class="si">{!r}</span><span class="s2">.&quot;</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">_ERR_MSG</span> <span class="o">+</span> <span class="s2">&quot;; </span><span class="si">{!r}</span><span class="s2"> is not a package&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_install_on_parent</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">module</span>

    <span class="c1"># note: copied from cpython&#39;s import code</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_find_and_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_NEEDS_LOADING</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="n">_NEEDS_LOADING</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_find_and_load</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;import of </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> halted; None in sys.modules&quot;</span>
            <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># To handle https://github.com/pytorch/pytorch/issues/57490, where std&#39;s</span>
        <span class="c1"># creation of fake submodules via the hacking of sys.modules is not import</span>
        <span class="c1"># friendly</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;os&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;os.path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;typing&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;typing.io&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span><span class="o">.</span><span class="n">io</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;typing.re&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span><span class="o">.</span><span class="n">re</span>

        <span class="k">return</span> <span class="n">module</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_gcd_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Import and return the module based on its name, the package the call is</span>
<span class="sd">        being made from, and the level adjustment.</span>

<span class="sd">        This function represents the greatest common denominator of functionality</span>
<span class="sd">        between import_module and __import__. This includes setting __package__ if</span>
<span class="sd">        the loader did not.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_sanity_check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">_resolve_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_and_load</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># note: copied from cpython&#39;s import code</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_fromlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">fromlist</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Figure out what __import__ should return.</span>

<span class="sd">        The import_ parameter is a callable which takes the name of module to</span>
<span class="sd">        import. It is required to decouple the function from assuming importlib&#39;s</span>
<span class="sd">        import implementation is desired.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="n">demangle</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="c1"># The hell that is fromlist ...</span>
        <span class="c1"># If a package was imported, try to import stuff from fromlist.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;__path__&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fromlist</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                        <span class="n">where</span> <span class="o">=</span> <span class="n">module_name</span> <span class="o">+</span> <span class="s2">&quot;.__all__&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">where</span> <span class="o">=</span> <span class="s2">&quot;``from list&#39;&#39;&quot;</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Item in </span><span class="si">{</span><span class="n">where</span><span class="si">}</span><span class="s2"> must be str, &quot;</span> <span class="sa">f</span><span class="s2">&quot;not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">recursive</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;__all__&quot;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_fromlist</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="n">__all__</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                    <span class="n">from_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_gcd_import</span><span class="p">(</span><span class="n">from_name</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="c1"># Backwards-compatibility dictates we ignore failed</span>
                        <span class="c1"># imports triggered by fromlist for modules that don&#39;t</span>
                        <span class="c1"># exist.</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">exc</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">from_name</span>
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">from_name</span><span class="p">,</span> <span class="n">_NEEDS_LOADING</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="k">raise</span>
        <span class="k">return</span> <span class="n">module</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__import__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">globals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">(),</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gcd_import</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">globals_</span> <span class="o">=</span> <span class="nb">globals</span> <span class="k">if</span> <span class="nb">globals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="n">package</span> <span class="o">=</span> <span class="n">_calc___package__</span><span class="p">(</span><span class="n">globals_</span><span class="p">)</span>
            <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gcd_import</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fromlist</span><span class="p">:</span>
            <span class="c1"># Return up to the first dot in &#39;name&#39;. This is complicated by the fact</span>
            <span class="c1"># that &#39;name&#39; may be relative.</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gcd_import</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">module</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Figure out where to slice the module&#39;s name up to the first dot</span>
                <span class="c1"># in &#39;name&#39;.</span>
                <span class="n">cut_off</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1"># Slice end needs to be positive to alleviate need to special-case</span>
                <span class="c1"># when ``&#39;.&#39; not in name``.</span>
                <span class="n">module_name</span> <span class="o">=</span> <span class="n">demangle</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_name</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span> <span class="o">-</span> <span class="n">cut_off</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_fromlist</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">fromlist</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Take a package name or module object and return the module.</span>

<span class="sd">        If a name, the module is imported.  If the passed or imported module</span>
<span class="sd">        object is not a package, raise an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="s2">&quot;__spec__&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">package</span><span class="o">.</span><span class="n">__spec__</span><span class="o">.</span><span class="n">submodule_search_locations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">package</span><span class="o">.</span><span class="n">__spec__</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> is not a package&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">package</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">module</span><span class="o">.</span><span class="n">__spec__</span><span class="o">.</span><span class="n">submodule_search_locations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">package</span><span class="si">!r}</span><span class="s2"> is not a package&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">module</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_zipfile_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">package</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_package</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">package</span><span class="o">.</span><span class="n">__loader__</span> <span class="ow">is</span> <span class="bp">self</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">demangle</span><span class="p">(</span><span class="n">package</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">_normalize_path</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_or_create_package</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Union[_PackageNode, _ExternNode]&quot;</span><span class="p">:</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">_PackageNode</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">_ExternNode</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">node</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">_ModuleNode</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">atoms</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;inconsistent module structure. module </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is not a package, but has submodules&quot;</span>
                <span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">_PackageNode</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assembles a Python module out of the given file. Will ignore files in the .data directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): the name of the file inside of the package archive to be added</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">*</span><span class="n">prefix</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">prefix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.data&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">package</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_package</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">_ExternNode</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;inconsistent module structure. package contains a module file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; that is a subpackage of a module marked external.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">last</span> <span class="o">==</span> <span class="s2">&quot;__init__.py&quot;</span><span class="p">:</span>
            <span class="n">package</span><span class="o">.</span><span class="n">source_file</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">elif</span> <span class="n">last</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">):</span>
            <span class="n">package_name</span> <span class="o">=</span> <span class="n">last</span><span class="p">[:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">)]</span>
            <span class="n">package</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">package_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ModuleNode</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_extern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extern_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="o">*</span><span class="n">prefix</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="n">extern_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">package</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_package</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">_ExternNode</span><span class="p">):</span>
            <span class="k">return</span>  <span class="c1"># the shorter extern covers this extern case</span>
        <span class="n">package</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">last</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ExternNode</span><span class="p">()</span></div>



<span class="n">_NEEDS_LOADING</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
<span class="n">_ERR_MSG_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;No module named &quot;</span>
<span class="n">_ERR_MSG</span> <span class="o">=</span> <span class="n">_ERR_MSG_PREFIX</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{!r}</span><span class="s2">&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_PathNode</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_PackageNode</span><span class="p">(</span><span class="n">_PathNode</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_file</span> <span class="o">=</span> <span class="n">source_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_PathNode</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_ModuleNode</span><span class="p">(</span><span class="n">_PathNode</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;source_file&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_file</span> <span class="o">=</span> <span class="n">source_file</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_ExternNode</span><span class="p">(</span><span class="n">_PathNode</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="c1"># A private global registry of all modules that have been package-imported.</span>
<span class="n">_package_imported_modules</span><span class="p">:</span> <span class="n">WeakValueDictionary</span> <span class="o">=</span> <span class="n">WeakValueDictionary</span><span class="p">()</span>

<span class="c1"># `inspect` by default only looks in `sys.modules` to find source files for classes.</span>
<span class="c1"># Patch it to check our private registry of package-imported modules as well.</span>
<span class="n">_orig_getfile</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_patched_getfile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">object</span><span class="o">.</span><span class="vm">__module__</span> <span class="ow">in</span> <span class="n">_package_imported_modules</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_package_imported_modules</span><span class="p">[</span><span class="nb">object</span><span class="o">.</span><span class="vm">__module__</span><span class="p">]</span><span class="o">.</span><span class="vm">__file__</span>
    <span class="k">return</span> <span class="n">_orig_getfile</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>


<span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span> <span class="o">=</span> <span class="n">_patched_getfile</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_PackageResourceReader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Private class used to support PackageImporter.get_resource_reader().</span>

<span class="sd">    Confirms to the importlib.abc.ResourceReader interface. Allowed to access</span>
<span class="sd">    the innards of PackageImporter.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">importer</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">importer</span> <span class="o">=</span> <span class="n">importer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fullname</span> <span class="o">=</span> <span class="n">fullname</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">open_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">BytesIO</span>

        <span class="k">return</span> <span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="o">.</span><span class="n">load_binary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span> <span class="n">resource</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">resource_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="c1"># The contract for resource_path is that it either returns a concrete</span>
        <span class="c1"># file system path or raises FileNotFoundError.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="o">.</span><span class="n">zip_reader</span><span class="p">,</span> <span class="n">DirectoryReader</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="o">.</span><span class="n">zip_reader</span><span class="o">.</span><span class="n">has_record</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="o">.</span><span class="n">zip_reader</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span> <span class="n">resource</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="o">.</span><span class="n">_zipfile_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="o">.</span><span class="n">zip_reader</span><span class="o">.</span><span class="n">has_record</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">contents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>

        <span class="n">fullname_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="o">.</span><span class="n">_zipfile_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fullname</span><span class="p">))</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">importer</span><span class="o">.</span><span class="n">zip_reader</span><span class="o">.</span><span class="n">get_all_records</span><span class="p">()</span>
        <span class="n">subdirs_seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">relative</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">fullname_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># If the path of the file (which is relative to the top of the zip</span>
            <span class="c1"># namespace), relative to the package given when the resource</span>
            <span class="c1"># reader was created, has a parent, then it&#39;s a name in a</span>
            <span class="c1"># subdirectory and thus we skip it.</span>
            <span class="n">parent_name</span> <span class="o">=</span> <span class="n">relative</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">relative</span><span class="o">.</span><span class="n">name</span>
            <span class="k">elif</span> <span class="n">parent_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subdirs_seen</span><span class="p">:</span>
                <span class="n">subdirs_seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">parent_name</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">parent_name</span>
</pre></div>

                </article>
              
              
              
                <footer class="bd-footer-article">
                  <div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item">
<div class="feedback">
  
<div class="rating">
    Rate this Page
    <div class="stars">
        
        <span class="star" data-value="1">★</span>
        
        <span class="star" data-value="2">★</span>
        
        <span class="star" data-value="3">★</span>
        
        <span class="star" data-value="4">★</span>
        
        <span class="star" data-value="5">★</span>
        
    </div>
</div>

  <div class="feedback-send">
    <button class="feedback-btn" onclick="openGitHubIssue()">Send Feedback</button>
  </div>
</div>
</div>
  
</div>
                </footer>
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>


  <footer class="bd-footer">
    
    <div class="bd-footer__inner bd-page-width">
      
        <div class="footer-items__start">
          
            <div class="footer-item">

  <p class="copyright">
    
      © Copyright PyTorch Contributors.
      <br/>
    
  </p>
</div>
          
            <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.0.
    <br/>
  </p>
</div>
          
        </div>
      
    
    
      <div class="footer-items__end">
        
          <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
        
      </div>
    
   </div>
   

   <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
      <div class="container">
        <div class="row">
          <div class="col-md-4 text-center">
            <h2>Docs</h2>
            <p>Access comprehensive developer documentation for PyTorch</p>
            <a class="with-right-arrow" href="">View Docs</a>
          </div>

          <div class="col-md-4 text-center">
            <h2>Tutorials</h2>
            <p>Get in-depth tutorials for beginners and advanced developers</p>
            <a class="with-right-arrow" href="">View Tutorials</a>
          </div>

          <div class="col-md-4 text-center">
            <h2>Resources</h2>
            <p>Find development resources and get your questions answered</p>
            <a class="with-right-arrow" href="">View Resources</a>
          </div>
        </div>
      </div>
  </div>

  <footer class="site-footer">
      <div class="container footer-container">
        <div class="footer-logo-wrapper">
          <a href="" class="footer-logo"></a>
        </div>

        <div class="footer-links-wrapper">
          <div class="footer-links-col">
            <ul>
              <li class="list-title"><a href="">PyTorch</a></li>
              <li><a href="">Get Started</a></li>
              <li><a href="">Features</a></li>
              <li><a href="">Ecosystem</a></li>
              <li><a href="">Blog</a></li>
              <li><a href="">Contributing</a></li>
            </ul>
          </div>

          <div class="footer-links-col">
            <ul>
              <li class="list-title"><a href="">Resources</a></li>
              <li><a href="">Tutorials</a></li>
              <li><a href="">Docs</a></li>
              <li><a href="" target="_blank">Discuss</a></li>
              <li><a href="" target="_blank">Github Issues</a></li>
              <li><a href="" target="_blank">Brand Guidelines</a></li>
            </ul>
          </div>

          <div class="footer-links-col">
            <ul>
              <li class="list-title">Stay up to date</li>
              <li><a href="" target="_blank">Facebook</a></li>
              <li><a href="" target="_blank">Twitter</a></li>
              <li><a href="" target="_blank">YouTube</a></li>
              <li><a href="" target="_blank">LinkedIn</a></li>
            </ul>
            </div>

          <div class="footer-links-col">
            <ul>
              <li class="list-title">PyTorch Podcasts</li>
              <li><a href="" target="_blank">Spotify</a></li>
              <li><a href="" target="_blank">Apple</a></li>
              <li><a href="" target="_blank">Google</a></li>
              <li><a href="" target="_blank">Amazon</a></li>
            </ul>
           </div>
          </div>

          <div class="privacy-policy">
            <ul>
              <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
              <li class="privacy-policy-links">|</li>
              <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
            </ul>
          </div>
          <div class="copyright">
          <p>© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
            For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
            <a href="https://www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
            project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
            please see <a href="https://www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
        </div>
       </div>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../_static/img/pytorch-x.svg">
  </div>
</div>
  </footer>


  </body>
</html>