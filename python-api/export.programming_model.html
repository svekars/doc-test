
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>torch.export Programming Model &#8212; PyTorch main documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=949a1ff5" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/katex-math.css?v=91adb8b6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/css/jit.css?v=8de1ea5d" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=3ccf5357" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom2.css?v=a9f46c5e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=a8da1a53"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=940804e7"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'python-api/export.programming_model';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="main (2.6.0 )" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>

          <li class="main-menu-item">
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Learn
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class=dropdown-title>Get Started</span>
                  <p>Run PyTorch locally or get started quickly with one of the supported cloud platforms</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Tutorials</span>
                  <p>Whats new in PyTorch tutorials</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Learn the Basics</span>
                  <p>Familiarize yourself with PyTorch concepts and modules</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch Recipes</span>
                  <p>Bite-size, ready-to-deploy PyTorch code examples</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Intro to PyTorch - YouTube Series</span>
                  <p>Master PyTorch basics with our engaging YouTube tutorial series</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Ecosystem
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Tools</span>
                  <p>Learn about the tools and frameworks in the PyTorch Ecosystem</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class=dropdown-title>Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="" target="_blank">
                  <span class=dropdown-title>Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class=dropdown-title>Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Contributor Awards - 2024</span>
                  <p>Award winners announced at this year's PyTorch Conference</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Edge
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">About PyTorch Edge</span>
                  <p>Build innovative and privacy-aware AI experiences for edge devices</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">ExecuTorch</span>
                  <p>End-to-end solution for enabling on-device inference capabilities across mobile and edge devices</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">ExecuTorch Docs</span>
                </a>
              </div>
            </div>  
          </li>

          <li class="main-menu-item">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch</span>
                  <p>Explore the documentation for comprehensive guidance on how to use PyTorch</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch Domains</span>
                  <p>Read the PyTorch Domains documentation to learn more about domain-specific libraries</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Blogs & News 
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch Blog</span>
                  <p>Catch up on the latest technical news and happenings</p>
                </a>
                 <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Community Blog</span>
                  <p>Stories from the PyTorch ecosystem</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Videos</span>
                  <p>Learn about the latest PyTorch tutorials, new, and more </p>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Newsletter</span>
                  <p>Stay up-to-date with the latest updates</p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                About
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn more about the PyTorch Foundation</p>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Governing Board</span>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Cloud Credit Program</span>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Technical Advisory Council</span>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Staff</span>
                </a>
                <a class="nav-dropdown-item" href="">
                  <span class="dropdown-title">Contact Us</span>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
            <div class="no-dropdown">
              <a href="" data-cta="join">
                Become a Member
              </a>
            </div>
          </li>
          <li>
           <div class="main-menu-item">
             <a href="" class="github-icon">
             </a>
           </div>
          </li>
          <!--- TODO: This block adds the search icon to the nav bar. We will enable it later. 
          <li>
            <div class="main-menu-item">
             <a href="" class="search-icon">
             </a>
            </div>
          </li>
          --->
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Home</p>
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="index.html">
    Python API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../notes/index.html">
    Developer Notes
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../community/index.html">
    Community
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../lang-bindings/index.html">
    Language Bindings
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://x.com/PyTorch" title="X" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-x-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">X</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/pytorch/pytorch" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/torch" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-custom fa-pypi fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="index.html">
    Python API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../notes/index.html">
    Developer Notes
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../community/index.html">
    Community
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../lang-bindings/index.html">
    Language Bindings
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://x.com/PyTorch" title="X" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-x-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">X</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/pytorch/pytorch" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/torch" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-custom fa-pypi fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"></div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">torch.export Programming Model</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="torch-export-programming-model">
<span id="export-programming-model"></span><h1>torch.export Programming Model<a class="headerlink" href="#torch-export-programming-model" title="Link to this heading">#</a></h1>
<p>This document aims to explain the behaviors and capabilities of
<a class="reference internal" href="export.html#torch.export.export" title="torch.export.export"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.export.export()</span></code></a>. It is intended to help build your intuition
for how <a class="reference internal" href="export.html#torch.export.export" title="torch.export.export"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.export.export()</span></code></a> handles code.</p>
<section id="basics-of-tracing">
<h2>Basics of Tracing<a class="headerlink" href="#basics-of-tracing" title="Link to this heading">#</a></h2>
<p><a class="reference internal" href="export.html#torch.export.export" title="torch.export.export"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.export.export()</span></code></a> captures a graph representing your model by
tracing its execution on “example” inputs and recording the PyTorch operations
and conditions observed along the traced path. This graph can then be run
on different inputs as long as they satisfy the same conditions.</p>
<p>The basic output of <a class="reference internal" href="export.html#torch.export.export" title="torch.export.export"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.export.export()</span></code></a> is a single graph of PyTorch
operations, with associated metadata. The exact format of this output is
covered in the <a class="reference internal" href="export.ir_spec.html#export-ir-spec"><span class="std std-ref">torch.export IR Specification</span></a>.</p>
<section id="strict-vs-non-strict-tracing">
<h3>Strict vs. Non-Strict Tracing<a class="headerlink" href="#strict-vs-non-strict-tracing" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="export.html#torch.export.export" title="torch.export.export"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.export.export()</span></code></a> provides two modes of tracing.</p>
<p>In <em>non-strict mode</em>, we trace through the program using the normal Python
interpreter. Your code executes exactly as it would in eager mode; the only
difference is that all Tensors are replaced by
<a class="reference external" href="https://pytorch.org/docs/main/torch.compiler_fake_tensor.html">fake Tensors</a>,
<strong>which have shapes and other forms of metadata but no data</strong>, wrapped in
<a class="reference external" href="https://pytorch.org/docs/main/fx.html">Proxy objects</a> that record all
operations on them into a graph. We also capture
<a class="reference external" href="https://pytorch.org/docs/main/torch.compiler_dynamic_shapes.html#the-guard-model">conditions on Tensor shapes</a>
<strong>that guard the correctness of the generated code</strong>.</p>
<p>In <em>strict mode</em>, we first trace through the program using
<a class="reference internal" href="torch.compiler_dynamo_deepdive.html#torch-compiler-dynamo-deepdive"><span class="std std-ref">TorchDynamo</span></a>, a Python bytecode
analysis engine. TorchDynamo does not actually execute your Python code.
Instead, it symbolically analyzes it and builds a graph based on the results.
On the one hand, this analysis allows <a class="reference internal" href="export.html#torch.export.export" title="torch.export.export"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.export.export()</span></code></a> to provide
additional guarantees on Python-level safety (beyond capturing conditions on
Tensor shapes, as in non-strict mode). On the other hand, not all Python
features are supported by this analysis.</p>
<p>Although currently the default mode of tracing is strict, <strong>we strongly
recommend using non-strict</strong>, which will soon become the default.
For most models, conditions on Tensor shapes are enough for soundness, and
the additional guarantees on Python-level safety have no impact; at the same
time, the possibility of hitting unsupported Python features in TorchDynamo
presents an unnecessary risk.</p>
<p>In the rest of this document we assume we are tracing in
<a class="reference external" href="https://pytorch.org/docs/main/export.html#non-strict-export">non-strict mode</a>;
in particular, we assume that <strong>all Python features are supported</strong>.</p>
</section>
</section>
<section id="values-static-vs-dynamic">
<h2>Values: Static vs. Dynamic<a class="headerlink" href="#values-static-vs-dynamic" title="Link to this heading">#</a></h2>
<p>A key concept in understanding the behavior of <a class="reference internal" href="export.html#torch.export.export" title="torch.export.export"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.export.export()</span></code></a> is
the difference between <em>static</em> and <em>dynamic</em> values.</p>
<section id="static-values">
<h3>Static Values<a class="headerlink" href="#static-values" title="Link to this heading">#</a></h3>
<p>A <em>static</em> value is a value that is <strong>fixed at export time and cannot change
between executions of the exported program</strong>. When the value is encountered
during tracing, we treat it as a constant and hard-code it into the graph.</p>
<p>When an operation is performed (e.g. <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">+</span> <span class="pre">y</span></code>) and all inputs are static,
the output of the operation is directly hard-coded into the graph and the
operation does not show up (i.e. it gets “constant-folded”).</p>
<p>When a value has been hard-coded into the graph, we say that the graph has
been <em>specialized</em> to that value. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyMod</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">7</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">z</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">MyMod</span><span class="p">(),</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">graph_module</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">def forward(self, arg0_1, arg1_1):</span>
<span class="sd">    add = torch.ops.aten.add.Tensor(arg0_1, 10);  arg0_1 = None</span>
<span class="sd">    return (add,)</span>

<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>Here, we provide <code class="docutils literal notranslate"><span class="pre">3</span></code> as the traced value for <code class="docutils literal notranslate"><span class="pre">y</span></code>; it is treated as a static
value and added to <code class="docutils literal notranslate"><span class="pre">7</span></code>, burning in the static value <code class="docutils literal notranslate"><span class="pre">10</span></code> in the graph.</p>
</section>
<section id="dynamic-values">
<h3>Dynamic Values<a class="headerlink" href="#dynamic-values" title="Link to this heading">#</a></h3>
<p>A <em>dynamic</em> value is one that <strong>can change from run to run</strong>. It behaves just
like a “normal” function argument: you can pass different inputs and expect
your function to do the right thing.</p>
</section>
<section id="which-values-are-static-vs-dynamic">
<h3>Which values are static vs. dynamic?<a class="headerlink" href="#which-values-are-static-vs-dynamic" title="Link to this heading">#</a></h3>
<p>Whether a value is static or dynamic depends on its type:</p>
<ul class="simple">
<li><p>For Tensor:</p>
<ul>
<li><p>Tensor <em>data</em> is treated as dynamic.</p></li>
<li><p>Tensor <em>shapes</em> can be treated by the system as static or dynamic.</p>
<ul>
<li><p>By default, shapes of all input Tensors are considered static.
The user can override this behavior for any input Tensor by specifying
a <a class="reference external" href="https://pytorch.org/docs/main/export.html#expressing-dynamism">dynamic shape</a>
for it.</p></li>
<li><p>Tensors that are part of module state, i.e., parameters and buffers,
always have static shapes.</p></li>
</ul>
</li>
<li><p>Other forms of Tensor <em>metadata</em> (e.g. <code class="docutils literal notranslate"><span class="pre">device</span></code>, <code class="docutils literal notranslate"><span class="pre">dtype</span></code>) are static.</p></li>
</ul>
</li>
<li><p>Python <em>primitives</em> (<code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">float</span></code>, <code class="docutils literal notranslate"><span class="pre">bool</span></code>, <code class="docutils literal notranslate"><span class="pre">str</span></code>, <code class="docutils literal notranslate"><span class="pre">None</span></code>) are static.</p>
<ul>
<li><p>There are dynamic variants for some primitive types (<code class="docutils literal notranslate"><span class="pre">SymInt</span></code>,
<code class="docutils literal notranslate"><span class="pre">SymFloat</span></code>, <code class="docutils literal notranslate"><span class="pre">SymBool</span></code>). Typically users do not have to deal with them.</p></li>
</ul>
</li>
<li><p>For Python <em>standard containers</em> (<code class="docutils literal notranslate"><span class="pre">list</span></code>, <code class="docutils literal notranslate"><span class="pre">tuple</span></code>, <code class="docutils literal notranslate"><span class="pre">dict</span></code>, <code class="docutils literal notranslate"><span class="pre">namedtuple</span></code>):</p>
<ul>
<li><p>The structure (i.e., length for <code class="docutils literal notranslate"><span class="pre">list</span></code> and <code class="docutils literal notranslate"><span class="pre">tuple</span></code> values, and key
sequence for <code class="docutils literal notranslate"><span class="pre">dict</span></code> and <code class="docutils literal notranslate"><span class="pre">namedtuple</span></code> values) is static.</p></li>
<li><p>The contained elements have these rules applied to them recursively
(basically the
<a class="reference external" href="https://jax.readthedocs.io/en/latest/pytrees.html">PyTree</a> scheme)
with leaves that are either Tensor or primitive types.</p></li>
</ul>
</li>
<li><p>Other <em>classes</em> (including data classes) can be registered with PyTree
(see below), and follow the same rules as the standard containers.</p></li>
</ul>
</section>
</section>
<section id="input-types">
<h2>Input types<a class="headerlink" href="#input-types" title="Link to this heading">#</a></h2>
<p>Inputs will be treated as either static or dynamic, based on their type
(as explained above).</p>
<ul class="simple">
<li><p>A static input will get hard-coded into the graph, and passing a different
value at run time will result in an error. Recall that these are mostly
values of primitive types.</p></li>
<li><p>A dynamic input behaves like a “normal” function input. Recall that these
are mostly values of Tensor types.</p></li>
</ul>
<p>By default, the types of inputs you can use for your program are:</p>
<ul class="simple">
<li><p>Tensor</p></li>
<li><p>Python primitives (<code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">float</span></code>, <code class="docutils literal notranslate"><span class="pre">bool</span></code>, <code class="docutils literal notranslate"><span class="pre">str</span></code>, <code class="docutils literal notranslate"><span class="pre">None</span></code>)</p></li>
<li><p>Python standard containers (<code class="docutils literal notranslate"><span class="pre">list</span></code>, <code class="docutils literal notranslate"><span class="pre">tuple</span></code>, <code class="docutils literal notranslate"><span class="pre">dict</span></code>, <code class="docutils literal notranslate"><span class="pre">namedtuple</span></code>)</p></li>
</ul>
<section id="custom-input-types">
<h3>Custom Input Types<a class="headerlink" href="#custom-input-types" title="Link to this heading">#</a></h3>
<p>In addition, you can also define your own (custom) class and use it as an
input type, but you will need to register such a class as a PyTree.</p>
<p>Here’s an example of using an utility to register a dataclass that is used as
an input type.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Input</span><span class="p">:</span>
    <span class="n">f</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="n">p</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>

<span class="n">torch</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">register_dataclass</span><span class="p">(</span><span class="n">Input</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">M</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Input</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">f</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">torch</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">M</span><span class="p">(),</span> <span class="p">(</span><span class="n">Input</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),))</span>
</pre></div>
</div>
</section>
<section id="optional-input-types">
<h3>Optional input types<a class="headerlink" href="#optional-input-types" title="Link to this heading">#</a></h3>
<p>For optional inputs to the program that are not passed in,
<a class="reference internal" href="export.html#torch.export.export" title="torch.export.export"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.export.export()</span></code></a> will specialize to their default values. As a
result, the exported program will require users to explicitly pass in all
arguments, and will lose the defaulting behavior. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">M</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span> <span class="o">*</span> <span class="n">x</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x</span>

<span class="c1"># Optional input is passed in</span>
<span class="n">ep</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">M</span><span class="p">(),</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ExportedProgram:</span>
<span class="sd">    class GraphModule(torch.nn.Module):</span>
<span class="sd">        def forward(self, x: &quot;f32[3, 3]&quot;, y: &quot;f32[3, 3]&quot;):</span>
<span class="sd">            # File: /data/users/angelayi/pytorch/moo.py:15 in forward, code: return y * x</span>
<span class="sd">            mul: &quot;f32[3, 3]&quot; = torch.ops.aten.mul.Tensor(y, x);  y = x = None</span>
<span class="sd">            return (mul,)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Optional input is not passed in</span>
<span class="n">ep</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">M</span><span class="p">(),</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ExportedProgram:</span>
<span class="sd">    class GraphModule(torch.nn.Module):</span>
<span class="sd">        def forward(self, x: &quot;f32[3, 3]&quot;, y):</span>
<span class="sd">            # File: /data/users/angelayi/pytorch/moo.py:16 in forward, code: return x + x</span>
<span class="sd">            add: &quot;f32[3, 3]&quot; = torch.ops.aten.add.Tensor(x, x);  x = None</span>
<span class="sd">            return (add,)</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="control-flow-static-vs-dynamic">
<h2>Control Flow: Static vs. Dynamic<a class="headerlink" href="#control-flow-static-vs-dynamic" title="Link to this heading">#</a></h2>
<p>Control flow is supported by <a class="reference internal" href="export.html#torch.export.export" title="torch.export.export"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.export.export()</span></code></a>. The behavior of
control flow depends on whether the value you are branching on is static or
dynamic.</p>
<section id="static-control-flow">
<h3>Static Control Flow<a class="headerlink" href="#static-control-flow" title="Link to this heading">#</a></h3>
<p><strong>Python control flow over static values is supported transparently</strong>. (Recall
that static values include static shapes, so control flow over static shapes
is also covered by this case.)</p>
<p>As mentioned above, we “burn in” static values, so the exported graph will
never see any control flow over static values.</p>
<p>In the case of an <code class="docutils literal notranslate"><span class="pre">if</span></code> statement, we will continue tracing the branch taken
at export time. In the case of a <code class="docutils literal notranslate"><span class="pre">for</span></code> or <code class="docutils literal notranslate"><span class="pre">while</span></code> statement, we will continue
tracing by unrolling the loop.</p>
</section>
<section id="dynamic-control-flow-shape-dependent-vs-data-dependent">
<h3>Dynamic Control Flow: Shape-Dependent vs. Data-Dependent<a class="headerlink" href="#dynamic-control-flow-shape-dependent-vs-data-dependent" title="Link to this heading">#</a></h3>
<p>When the value involved in a control flow is dynamic, it could depend on
dynamic shapes or dynamic data. Given that the compiler traces with
information on shapes rather than data, the implications on the programming
model are different in these cases.</p>
<section id="dynamic-shape-dependent-control-flow">
<h4>Dynamic Shape-Dependent Control Flow<a class="headerlink" href="#dynamic-shape-dependent-control-flow" title="Link to this heading">#</a></h4>
<p>When the value involved in a control flow is a
<a class="reference external" href="https://pytorch.org/docs/main/torch.compiler_dynamic_shapes.html">dynamic shape</a>,
in most cases <strong>we will also know the concrete value of the dynamic shape
during tracing</strong>: see the following section for more details on how the
compiler tracks this information.</p>
<p>In these cases we say that the control flow is shape-dependent. <strong>We use the
concrete value of the dynamic shape to evaluate the condition</strong> to either
<code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code> and continue tracing (as discussed above), additionally
emitting a guard corresponding to the condition just evaluated.</p>
<p>Otherwise the control flow is considered data-dependent. We cannot evaluate
the condition to either <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code>, so cannot continue tracing and have to
raise an error at export time. See next section.</p>
</section>
<section id="dynamic-data-dependent-control-flow">
<h4>Dynamic Data-Dependent Control Flow<a class="headerlink" href="#dynamic-data-dependent-control-flow" title="Link to this heading">#</a></h4>
<p><strong>Data-dependent control flow over dynamic values is supported, but you must
use one of PyTorch’s explicit operators</strong> to continue tracing. Using Python
control flow statements over dynamic values is not permitted, because the
compiler cannot evaluate the conditions necessary to continue tracing and
thus an error must be raised at export time.</p>
<p>We provide <strong>operators to express general conditionals and loops over dynamic
values</strong>, e.g., <cite>torch.cond</cite>, <cite>torch.map</cite>. Note that you only need to use these
if you truly want <em>data-dependent control flow</em>.</p>
<p>Here’s an example of an <code class="docutils literal notranslate"><span class="pre">if</span></code> statement on a data-dependent condition,
<code class="docutils literal notranslate"><span class="pre">x.sum()</span> <span class="pre">&gt;</span> <span class="pre">0</span></code>, where <code class="docutils literal notranslate"><span class="pre">x</span></code> is an input Tensor, rewritten using <cite>torch.cond</cite>.
Instead of having to decide which branch to trace, now both branches are
traced.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">M_old</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span>

<span class="k">class</span><span class="w"> </span><span class="nc">M_new</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">pred</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">true_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sin</span><span class="p">(),</span>
            <span class="n">false_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">cos</span><span class="p">(),</span>
            <span class="n">operands</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,),</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>A special case of data-dependent control flow is where it involves a
<a class="reference external" href="https://pytorch.org/docs/main/torch.compiler_dynamic_shapes.html#unbacked-symints">data-dependent dynamic shape</a>:
typically, the shape of some intermediate Tensor that depends on input data
rather than on input shapes (thus not shape-dependent). Instead of using a
control flow operator, in this case you can provide an assertion that decides
whether the condition is <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code>. Given such an assertion, we can
continue tracing, emitting a guard as above.</p>
<p>We provide <strong>operators to express assertions on dynamic shapes</strong>, e.g.,
<cite>torch._check</cite>. Note that you only need to use this when there is control
flow on data-dependent dynamic shapes.</p>
<p>Here’s an example of an <code class="docutils literal notranslate"><span class="pre">if</span></code> statement on a condition involving a
data-dependent dynamic shape, <code class="docutils literal notranslate"><span class="pre">nz.shape[0]</span> <span class="pre">&gt;</span> <span class="pre">0</span></code>, where <code class="docutils literal notranslate"><span class="pre">nz</span></code> is the result of
calling <a class="reference internal" href="generated/torch.nonzero.html#torch.nonzero" title="torch.nonzero"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.nonzero()</span></code></a>, an operator whose output shape depends on input
data. Instead of rewriting it, you can add an assertion using <cite>torch._check</cite>
to effectively decide which branch to trace.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">M_old</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">nz</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">nz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span>

<span class="k">class</span><span class="w"> </span><span class="nc">M_new</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">nz</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="n">nz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="basics-of-symbolic-shapes">
<h2>Basics of Symbolic Shapes<a class="headerlink" href="#basics-of-symbolic-shapes" title="Link to this heading">#</a></h2>
<p>During tracing, dynamic Tensor shapes and conditions over them are encoded as
“symbolic expressions.” (In contrast, static Tensor shapes and conditions
over them are simply <code class="docutils literal notranslate"><span class="pre">int</span></code> and <code class="docutils literal notranslate"><span class="pre">bool</span></code> values.)</p>
<p>A <em>symbol</em> is like a variable; it describes a dynamic Tensor shape.</p>
<p>As tracing proceeds, shapes of intermediate Tensors may be described by more
general expressions, typically involving integer arithmetic operators. This
is because <strong>for most PyTorch operators, shapes of output Tensors can be
described as functions of shapes of input Tensors</strong>. For example, the shape of
the output of <a class="reference internal" href="generated/torch.cat.html#torch.cat" title="torch.cat"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.cat()</span></code></a> is the sum of the shapes of its inputs.</p>
<p>Moreover, as we encounter control flow in the program, we create boolean
expressions, typically involving relational operators, describing conditions
along the traced path. These <strong>expressions are evaluated to decide which path
to trace through the program</strong>, and recorded in a
<a class="reference external" href="https://pytorch.org/docs/main/torch.compiler_dynamic_shapes.html#overall-architecture">shape environment</a>
to guard the correctness of the traced path and to evaluate subsequently
created expressions.</p>
<p>We briefly introduce these subsystems next.</p>
<section id="fake-implementations-of-pytorch-operators">
<h3>Fake Implementations of PyTorch Operators<a class="headerlink" href="#fake-implementations-of-pytorch-operators" title="Link to this heading">#</a></h3>
<p>Recall that during tracing, we are executing the program with
<a class="reference external" href="https://pytorch.org/docs/main/torch.compiler_fake_tensor.html">fake Tensors</a>,
which have no data. In general we cannot call the actual implementations of
PyTorch operators with fake Tensors. Thus each operator needs to have an
additional fake (a.k.a. “meta”) implementation, which inputs and outputs fake
Tensors, that matches the behavior of the actual implementation in terms of
shapes and other forms of metadata carried by fake Tensors.</p>
<p>For example, note how the fake implementation of <a class="reference internal" href="generated/torch.index_select.html#torch.index_select" title="torch.index_select"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.index_select()</span></code></a>
computes the shape of the output using the shape of the input (while ignoring
input data and returning empty output data).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">meta_index_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="n">result_size</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">result_size</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_empty</span><span class="p">(</span><span class="n">result_size</span><span class="p">)</span>
</pre></div>
</div>
<section id="shape-propagation-backed-vs-unbacked-dynamic-shapes">
<h4>Shape Propagation: Backed vs. Unbacked Dynamic Shapes<a class="headerlink" href="#shape-propagation-backed-vs-unbacked-dynamic-shapes" title="Link to this heading">#</a></h4>
<p>Shapes are propagated using fake implementations of PyTorch operators.</p>
<p>A key concept to understand the propagation of dynamic shapes in particular
is the difference between <em>backed</em> and <em>unbacked</em> dynamic shapes: we know the
concrete values of the former but not the latter.</p>
<p>Propagation of shapes, including tracking backed and unbacked dynamic shapes,
proceeds as follows:</p>
<ul class="simple">
<li><p>The shapes of Tensors representing inputs can be static or dynamic. When
dynamic, they are described by symbols; moreover, <strong>such symbols are backed
since we also know their concrete values given the “real” example inputs
provided by the user at export time</strong>.</p></li>
<li><p>The output shape of an operator is computed by its fake implementation, and
is either static or dynamic. When dynamic, in general it is described by a
symbolic expression. Moreover:</p>
<ul>
<li><p>If the output shape depends only on input shapes, it is either static or
backed dynamic whenever the input shapes are all static or backed dynamic.</p></li>
<li><p>On the other hand, <strong>if the output shape depends on input data</strong>, it is
necessarily dynamic, and moreover, <strong>because we cannot know its concrete
value it is unbacked</strong>.</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="control-flow-guards-and-assertions">
<h3>Control Flow: Guards and Assertions<a class="headerlink" href="#control-flow-guards-and-assertions" title="Link to this heading">#</a></h3>
<p>When a condition on shapes is encountered, it either involves only static
shapes, in which case it is a <code class="docutils literal notranslate"><span class="pre">bool</span></code>, or it involves dynamic shapes, in which
case it is a symbolic boolean expression. For the latter:</p>
<ul class="simple">
<li><p>When the condition involves only backed dynamic shapes, we can use the
concrete values of those dynamic shapes to evaluate the condition to <code class="docutils literal notranslate"><span class="pre">True</span></code>
or <code class="docutils literal notranslate"><span class="pre">False</span></code>. We can then add a guard to the shape environment that states
that the corresponding symbolic boolean expression is <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code>,
and continue tracing.</p></li>
<li><p>Otherwise the condition involves unbacked dynamic shapes. In general we
cannot evaluate such a condition without additional information; thus we
cannot continue tracing, and we must raise an error at export time. The
user is expected to use an explicit PyTorch operator for tracing to
continue. This information is added as a guard in the shape environment,
and can also possibly help evaluate other subsequently encountered
conditions to <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p></li>
</ul>
<p>Once the model is exported, <strong>any guards on backed dynamic shapes can be
understood as conditions on input dynamic shapes</strong>. These are verified against
a dynamic shape specification that must have been provided to export,
describing conditions on dynamic shapes that not only example inputs but also
all future inputs are expected to satisfy for the generated code to be
correct. More precisely, the dynamic shape specification must logically imply
the generated guards, otherwise an error is raised at export time (along with
suggested fixes to the dynamic shape specification). On the other hand, when
there are no generated guards on backed dynamic shapes (in particular, when
all shapes are static) no dynamic shape specification needs to be provided to
export. In general, the dynamic shape specification is converted to runtime
assertions on the inputs of the generated code.</p>
<p>Finally, <strong>any guards on unbacked dynamic shapes are converted to “inline”
runtime assertions</strong>. These are added in the generated code at the locations
where those unbacked dynamic shapes were created: typically, right after
data-dependent operator calls.</p>
</section>
</section>
<section id="allowed-pytorch-operators">
<h2>Allowed PyTorch operators<a class="headerlink" href="#allowed-pytorch-operators" title="Link to this heading">#</a></h2>
<p>All PyTorch operators are permitted.</p>
<section id="custom-operators">
<h3>Custom operators<a class="headerlink" href="#custom-operators" title="Link to this heading">#</a></h3>
<p>In addition, you can define and use
<a class="reference external" href="https://pytorch.org/tutorials/advanced/python_custom_ops#python-custom-ops-tutorial">custom operators</a>.
Defining a custom operator includes defining a fake implementation for it,
just like any other PyTorch operator (see previous section).</p>
<p>Here’s an example of a custom <code class="docutils literal notranslate"><span class="pre">sin</span></code> operator that wraps NumPy, and its
registered (trivial) fake implementation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@torch</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">custom_op</span><span class="p">(</span><span class="s2">&quot;mylib::sin&quot;</span><span class="p">,</span> <span class="n">mutates_args</span><span class="o">=</span><span class="p">())</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sin</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="n">x_np</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">y_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x_np</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y_np</span><span class="p">)</span>

<span class="nd">@torch</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">register_fake</span><span class="p">(</span><span class="s2">&quot;mylib::sin&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Sometimes your custom operator’s fake implementation will involve
data-dependent shapes</strong>. Here’s how a fake implementation for a custom
<code class="docutils literal notranslate"><span class="pre">nonzero</span></code> might look like.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="nd">@torch</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">register_fake</span><span class="p">(</span><span class="s2">&quot;mylib::custom_nonzero&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">nnz</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">get_ctx</span><span class="p">()</span><span class="o">.</span><span class="n">new_dynamic_size</span><span class="p">()</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">nnz</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">dim</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">new_empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="module-state-reads-vs-updates">
<h2>Module State: Reads vs. Updates<a class="headerlink" href="#module-state-reads-vs-updates" title="Link to this heading">#</a></h2>
<p>Module states include parameters, buffers, and regular attributes.</p>
<ul class="simple">
<li><p>A regular attribute can be of any type.</p></li>
<li><p>On the other hand, parameters and buffers are always Tensors.</p></li>
</ul>
<p>Module states can be dynamic or static, based on their types as outlined
above. For example, <code class="docutils literal notranslate"><span class="pre">self.training</span></code> is a <code class="docutils literal notranslate"><span class="pre">bool</span></code>, which means it is static; on
the other hand, any parameter or buffer is dynamic.</p>
<p>The <em>shapes</em> of any Tensors contained in module states cannot be dynamic, i.e.,
those shapes are fixed at export time, and cannot change between executions
of the exported program.</p>
<section id="access-rules">
<h3>Access rules<a class="headerlink" href="#access-rules" title="Link to this heading">#</a></h3>
<p><strong>All module states must be initialized</strong>. Accessing a module state that is
not already initialized causes an error to be raised at export time.</p>
<p><strong>Reading module states is always permitted</strong>.</p>
<p>Updating module states is possible, but must follow the rules below:</p>
<ul class="simple">
<li><p><strong>A static regular attribute</strong> (e.g., of primitive type) <strong>can be updated</strong>.
Reads and updates can be freely interleaved, and as expected, any reads
will always see the values of the latest updates. Because these attributes
are static, we will also burn the values in, so the generated code will not
have any instructions to actually “get” or “set” such attributes.</p></li>
<li><p><strong>A dynamic regular attribute</strong> (e.g., of Tensor type) <strong>cannot be updated</strong>.
To do so, it must be registered as a buffer during module initialization.</p></li>
<li><p><strong>A buffer can be updated</strong>, where the updating can be in-place (e.g.,
<code class="docutils literal notranslate"><span class="pre">self.buffer[:]</span> <span class="pre">=</span> <span class="pre">...</span></code>) or not (e.g., <code class="docutils literal notranslate"><span class="pre">self.buffer</span> <span class="pre">=</span> <span class="pre">...</span></code>).</p></li>
<li><p><strong>A parameter cannot be updated</strong>. Typically parameters are updated only
during training, not during inference. We recommend exporting with
<a class="reference internal" href="generated/torch.no_grad.html#torch.no_grad" title="torch.no_grad"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.no_grad()</span></code></a> to avoid parameter updates at export time.</p></li>
</ul>
</section>
<section id="effects-of-functionalization">
<h3>Effects of functionalization<a class="headerlink" href="#effects-of-functionalization" title="Link to this heading">#</a></h3>
<p>Any dynamic module state that is read and/or updated is “lifted”
(respectively) as an input and/or output of the generated code.</p>
<p>The exported program stores, along with the generated code, the initial
values of parameters and buffers and the constant values of other Tensor
attributes.</p>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc">
<div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#basics-of-tracing">Basics of Tracing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#strict-vs-non-strict-tracing">Strict vs. Non-Strict Tracing</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#values-static-vs-dynamic">Values: Static vs. Dynamic</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#static-values">Static Values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dynamic-values">Dynamic Values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#which-values-are-static-vs-dynamic">Which values are static vs. dynamic?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#input-types">Input types</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-input-types">Custom Input Types</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-input-types">Optional input types</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#control-flow-static-vs-dynamic">Control Flow: Static vs. Dynamic</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#static-control-flow">Static Control Flow</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dynamic-control-flow-shape-dependent-vs-data-dependent">Dynamic Control Flow: Shape-Dependent vs. Data-Dependent</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dynamic-shape-dependent-control-flow">Dynamic Shape-Dependent Control Flow</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dynamic-data-dependent-control-flow">Dynamic Data-Dependent Control Flow</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#basics-of-symbolic-shapes">Basics of Symbolic Shapes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fake-implementations-of-pytorch-operators">Fake Implementations of PyTorch Operators</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#shape-propagation-backed-vs-unbacked-dynamic-shapes">Shape Propagation: Backed vs. Unbacked Dynamic Shapes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#control-flow-guards-and-assertions">Control Flow: Guards and Assertions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#allowed-pytorch-operators">Allowed PyTorch operators</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-operators">Custom operators</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#module-state-reads-vs-updates">Module State: Reads vs. Updates</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#access-rules">Access rules</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#effects-of-functionalization">Effects of functionalization</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/pytorch/pytorch/edit/main/docs/source/python-api/export.programming_model.rst">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">
    <div class="tocsection sourcelink">
      <a href="../_sources/python-api/export.programming_model.rst.txt">
        <i class="fa-solid fa-file-lines"></i> Show Source
      </a>
    </div>
</div>

</div>
<div class="sidebar-secondary-item">
 <h6>PyTorch Libraries</h6>
 <ul>
 
  <li><a class="nav-link nav-external" href="https://pytorch.org/audio/stable/">torchaudio</a></li>
 
  <li><a class="nav-link nav-external" href="https://pytorch.org/ao">torchao</a></li>
 
  <li><a class="nav-link nav-external" href="https://pytorch.org/executorch">ExecuTorch</a></li>
 
  <li><a class="nav-link nav-external" href="https://pytorch.org/torchrec">torchrec</a></li>
 
  <li><a class="nav-link nav-external" href="https://pytorch.org/serve/">torchserve</a></li>
 
  <li><a class="nav-link nav-external" href="https://pytorch.org/data">torchdata</a></li>
 
  <li><a class="nav-link nav-external" href="https://pytorch.org/data">torchvision</a></li>
 
  <li><a class="nav-link nav-external" href="https://pytorch.org/xla">PyTorch on XLA Devices</a></li>
 
 </ul>
</div>
</div>
</div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>


  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright PyTorch Contributors.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.0.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>